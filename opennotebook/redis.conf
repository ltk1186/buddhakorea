# Redis configuration for Buddha Korea Analytics
# Production-grade settings with AOF persistence

# Network
bind 0.0.0.0
port 6379
protected-mode yes
requirepass ${REDIS_PASSWORD}

# Memory management
maxmemory 512mb
maxmemory-policy allkeys-lru

# Persistence - Append Only File (AOF)
# AOF provides better durability than RDB for analytics data
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec  # Good balance between performance and durability

# AOF rewrite settings
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# RDB snapshot (backup only, not primary persistence)
save 900 1      # Save after 900 sec (15 min) if at least 1 key changed
save 300 10     # Save after 300 sec (5 min) if at least 10 keys changed
save 60 10000   # Save after 60 sec if at least 10000 keys changed

dbfilename dump.rdb

# Working directory
dir /data

# Logging
loglevel notice
logfile ""  # Log to stdout (Docker captures this)

# Slow query log
slowlog-log-slower-than 10000  # 10ms threshold
slowlog-max-len 128

# Client connection limits
maxclients 100
timeout 300

# Snapshotting on error
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes

# Lua scripting
lua-time-limit 5000

# Performance tuning
hz 10
dynamic-hz yes

# Disable dangerous commands in production
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command CONFIG ""
