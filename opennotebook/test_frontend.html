<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î∂àÍµê AI Ï±óÎ¥á ÌÖåÏä§Ìä∏ | Buddhist AI Chatbot</title>
    <style>
        /* ===== CSS CUSTOM PROPERTIES (Variables) ===== */
        :root {
            /* Buddha Korea Gradient Colors */
            --gradient-purple: #a794e0;
            --gradient-blue: #89b8ff;
            --gradient-green: #9bebb4;

            /* Dark Mode Base Colors */
            --color-bg-dark: #0A0E27;
            --color-bg-medium: #1A1E3F;
            --color-bg-light: #242952;

            /* Premium Accents */
            --gold-sacred: #DAA520;
            --gold-glow: rgba(218, 165, 32, 0.15);

            /* Glass & Effects */
            --glass-overlay: rgba(255, 255, 255, 0.03);
            --glass-overlay-hover: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(167, 148, 224, 0.2);
            --shadow-premium: 0 8px 32px rgba(0, 0, 0, 0.4);

            /* Typography */
            --font-korean: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            --text-body: 1.05rem;
            --text-small: 0.9rem;
            --text-tiny: 0.75rem;
            --line-height-relaxed: 1.8;

            /* Spacing */
            --space-xs: 8px;
            --space-sm: 12px;
            --space-md: 20px;
            --space-lg: 32px;
            --space-xl: 48px;

            /* Transitions */
            --transition-smooth: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            --transition-fast: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-korean);
            background: linear-gradient(135deg, var(--color-bg-dark) 0%, var(--color-bg-medium) 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            gap: 20px;
            color: rgba(255, 255, 255, 0.95);
            position: relative;
            overflow-x: hidden;
        }

        /* Ambient Orb Effects */
        body::before,
        body::after {
            content: '';
            position: fixed;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.08;
            pointer-events: none;
            z-index: 0;
        }

        body::before {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, var(--gradient-purple), transparent);
            top: -200px;
            right: -200px;
            animation: float-orb1 40s ease-in-out infinite;
        }

        body::after {
            width: 350px;
            height: 350px;
            background: radial-gradient(circle, var(--gradient-blue), transparent);
            bottom: -175px;
            left: -175px;
            animation: float-orb2 40s ease-in-out infinite;
            animation-delay: -15s;
        }

        @keyframes float-orb1 {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }
            25% {
                transform: translate(100px, -100px) scale(1.1);
            }
            50% {
                transform: translate(-50px, 100px) scale(0.9);
            }
            75% {
                transform: translate(-100px, -50px) scale(1.05);
            }
        }

        @keyframes float-orb2 {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }
            25% {
                transform: translate(-80px, 80px) scale(1.05);
            }
            50% {
                transform: translate(60px, -60px) scale(0.95);
            }
            75% {
                transform: translate(100px, 50px) scale(1.08);
            }
        }

        .sidebar {
            width: 380px;
            height: calc(100vh - 40px);
            background: linear-gradient(180deg,
                rgba(26, 30, 63, 0.95) 0%,
                rgba(36, 41, 82, 0.9) 100%);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            box-shadow: 4px 0 32px rgba(0, 0, 0, 0.3), var(--shadow-premium);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            z-index: 10;
        }

        .sidebar.collapsed {
            transform: translateX(-370px);
        }

        .sidebar-header {
            background: transparent;
            color: white;
            padding: var(--space-lg) var(--space-md);
            text-align: center;
            border-bottom: 1px solid rgba(167, 148, 224, 0.15);
        }

        .sidebar-header h2 {
            font-size: 18px;
            margin-bottom: 8px;
            background: linear-gradient(90deg, var(--gradient-purple), var(--gradient-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 600;
        }

        .sidebar-header p {
            font-size: var(--text-small);
            opacity: 0.7;
            color: rgba(255, 255, 255, 0.8);
        }

        .sidebar-search {
            padding: 15px;
            border-bottom: 1px solid rgba(167, 148, 224, 0.15);
        }

        .sidebar-search input {
            width: 100%;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(167, 148, 224, 0.2);
            border-radius: 20px;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.95);
            outline: none;
            transition: var(--transition-fast);
        }

        .sidebar-search input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .sidebar-search input:focus {
            border-color: var(--gradient-purple);
            background: rgba(255, 255, 255, 0.12);
            box-shadow: 0 0 0 3px rgba(167, 148, 224, 0.15);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .source-card {
            background: var(--glass-overlay);
            border: 1px solid rgba(167, 148, 224, 0.15);
            border-left: 3px solid transparent;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: var(--space-sm);
            cursor: pointer;
            transition: var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .source-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(167, 148, 224, 0.15),
                transparent
            );
            transition: left 0.5s ease;
        }

        .source-card:hover {
            background: var(--glass-overlay-hover);
            border-left-color: var(--gold-sacred);
            transform: translateX(6px);
            box-shadow: 0 4px 20px rgba(218, 165, 32, 0.2);
        }

        .source-card:hover::before {
            left: 100%;
        }

        .source-card-title {
            font-size: 13px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
            margin-bottom: 5px;
        }

        .source-card-summary {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.65);
            line-height: 1.5;
            margin-bottom: 5px;
        }

        .source-card-meta {
            display: flex;
            gap: 5px;
            font-size: 10px;
        }

        .source-tag {
            padding: 2px 8px;
            background: linear-gradient(135deg, var(--gradient-purple), var(--gradient-blue));
            border-radius: 10px;
            color: white;
            font-size: 10px;
            font-weight: 600;
        }

        .sidebar-toggle {
            position: absolute;
            left: 370px;
            top: 50%;
            transform: translateY(-50%);

            /* Modern minimal background - Linear/Notion inspired */
            background: linear-gradient(135deg,
                rgba(26, 30, 63, 0.7) 0%,
                rgba(36, 41, 82, 0.65) 100%);
            border: 1px solid rgba(167, 148, 224, 0.25);

            width: 36px;
            height: 36px;
            border-radius: 10px; /* Rounded square - more modern than circle */

            /* Subtle layered shadows - Apple/Linear pattern */
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.12),
                0 1px 3px rgba(0, 0, 0, 0.08),
                inset 0 0 0 1px rgba(255, 255, 255, 0.05);

            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;

            /* Smooth transitions for all properties */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);

            z-index: 100; /* Higher z-index for better layering */
            backdrop-filter: blur(12px);
            color: rgba(255, 255, 255, 0.7);

            /* Accessibility */
            outline: none;
        }

        /* Focus state for keyboard navigation */
        .sidebar-toggle:focus-visible {
            outline: 2px solid rgba(167, 148, 224, 0.6);
            outline-offset: 2px;
        }

        .sidebar-toggle:hover {
            /* Premium gradient on hover - Figma/Linear inspired */
            background: linear-gradient(135deg,
                rgba(167, 148, 224, 0.35) 0%,
                rgba(137, 184, 255, 0.3) 100%);

            color: rgba(255, 255, 255, 0.95);
            border-color: rgba(167, 148, 224, 0.5);

            /* Subtle lift effect */
            transform: translateY(-50%) translateX(-2px);

            /* Enhanced shadow on hover */
            box-shadow:
                0 4px 16px rgba(167, 148, 224, 0.2),
                0 2px 8px rgba(137, 184, 255, 0.15),
                inset 0 0 0 1px rgba(255, 255, 255, 0.15);
        }

        .sidebar-toggle:active {
            /* Pressed state - quick scale down */
            transform: translateY(-50%) scale(0.96);
            box-shadow:
                0 1px 4px rgba(0, 0, 0, 0.15),
                inset 0 0 0 1px rgba(255, 255, 255, 0.05);
        }

        /* Collapsed state - button moves to left edge */
        .sidebar.collapsed + .sidebar-toggle {
            left: 20px;

            /* Icon rotation animation when collapsed */
            transform: translateY(-50%) rotate(180deg);
        }

        /* Icon rotation on collapsed hover */
        .sidebar.collapsed + .sidebar-toggle:hover {
            transform: translateY(-50%) rotate(180deg) translateX(-2px);
        }

        /* Icon rotation on collapsed active */
        .sidebar.collapsed + .sidebar-toggle:active {
            transform: translateY(-50%) rotate(180deg) scale(0.96);
        }

        .container {
            flex: 1;
            max-width: 900px;
            background: linear-gradient(180deg,
                rgba(26, 30, 63, 0.95) 0%,
                rgba(36, 41, 82, 0.9) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: var(--shadow-premium);
            overflow: hidden;
            position: relative;
            z-index: 10;

            /* Flexbox layout for flexible height */
            display: flex;
            flex-direction: column;
            height: calc(100vh - 40px);
        }

        /* Source Detail Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--color-bg-medium);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(16px);
            border-radius: 20px;
            max-width: 720px;
            max-height: 80vh;
            overflow: visible; /* Allow arrows to extend outside */
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            position: relative; /* For arrow positioning */
            display: flex;
            flex-direction: column;
        }

        .modal-scroll-wrapper {
            overflow-y: auto;
            max-height: 80vh;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--gradient-purple), var(--gradient-blue));
            color: white;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 1;
            border-radius: 20px 20px 0 0;
        }

        .modal-header h3 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .modal-header p {
            font-size: 12px;
            opacity: 0.9;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-section {
            margin-bottom: 20px;
        }

        .modal-section h4 {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.95);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .modal-section p {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.75);
            line-height: 1.8;
        }

        .modal-themes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .theme-tag {
            padding: 5px 12px;
            background: rgba(167, 148, 224, 0.15);
            border: 1px solid rgba(167, 148, 224, 0.3);
            border-radius: 15px;
            font-size: 11px;
            color: var(--gradient-purple);
            font-weight: 500;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Modal Navigation Arrows - Premium Modern Design */
        .modal-nav-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);

            /* Elegant glass morphism */
            background: linear-gradient(135deg,
                rgba(26, 30, 63, 0.75) 0%,
                rgba(36, 41, 82, 0.7) 100%);
            border: 1.5px solid rgba(167, 148, 224, 0.35);

            width: 44px;
            height: 44px;
            border-radius: 12px; /* Softer rounded square */

            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;

            /* Premium layered shadows */
            box-shadow:
                0 8px 24px rgba(0, 0, 0, 0.25),
                0 4px 12px rgba(0, 0, 0, 0.18),
                inset 0 1px 1px rgba(255, 255, 255, 0.1),
                inset 0 -1px 1px rgba(0, 0, 0, 0.1);

            backdrop-filter: blur(16px);
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            outline: none;

            /* Remove default font */
            font-size: 0;
        }

        /* Beautiful chevron arrow using pseudo-elements */
        .modal-nav-button::before {
            content: '';
            width: 10px;
            height: 10px;
            border-top: 2.5px solid rgba(255, 255, 255, 0.75);
            border-right: 2.5px solid rgba(255, 255, 255, 0.75);
            border-radius: 2px;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-nav-button.prev::before {
            transform: rotate(-135deg);
            margin-left: 3px; /* Visual centering */
        }

        .modal-nav-button.next::before {
            transform: rotate(45deg);
            margin-right: 3px; /* Visual centering */
        }

        .modal-nav-button:hover {
            /* Vibrant gradient on hover */
            background: linear-gradient(135deg,
                rgba(167, 148, 224, 0.5) 0%,
                rgba(137, 184, 255, 0.45) 100%);
            border-color: rgba(167, 148, 224, 0.7);

            /* Subtle lift and scale */
            transform: translateY(-50%) translateY(-2px) scale(1.05);

            /* Enhanced glow */
            box-shadow:
                0 12px 32px rgba(167, 148, 224, 0.3),
                0 6px 16px rgba(137, 184, 255, 0.25),
                inset 0 1px 1px rgba(255, 255, 255, 0.2),
                inset 0 -1px 1px rgba(0, 0, 0, 0.05);
        }

        .modal-nav-button:hover::before {
            border-color: rgba(255, 255, 255, 0.95);
            /* Subtle chevron shift on hover */
        }

        .modal-nav-button.prev:hover::before {
            transform: rotate(-135deg) translateX(-1px);
        }

        .modal-nav-button.next:hover::before {
            transform: rotate(45deg) translateX(1px);
        }

        .modal-nav-button:active {
            transform: translateY(-50%) scale(0.96);
            box-shadow:
                0 4px 12px rgba(0, 0, 0, 0.2),
                inset 0 0 0 1px rgba(255, 255, 255, 0.1);
        }

        .modal-nav-button:disabled {
            opacity: 0.25;
            cursor: not-allowed;
            pointer-events: none;
            filter: grayscale(0.5);
        }

        .modal-nav-button:disabled::before {
            border-color: rgba(255, 255, 255, 0.3);
        }

        .modal-nav-button.prev {
            left: -50px;
        }

        .modal-nav-button.next {
            right: -50px;
        }

        /* Keyboard shortcut hint - hidden */
        .modal-nav-hint {
            display: none;
        }

        /* Responsive adjustments */
        @media (max-width: 900px) {
            .modal-nav-button {
                display: none; /* Hide arrows on smaller screens */
            }
        }

        @media (max-width: 1200px) {
            body {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                max-height: 300px;
            }

            .sidebar.collapsed {
                transform: translateY(-320px);
            }

            .sidebar-toggle {
                left: 50%;
                transform: translateX(-50%);
                top: auto;
                bottom: -20px;
            }

            .sidebar.collapsed + .sidebar-toggle {
                left: 50%;
                transform: translateX(-50%);
                top: -20px;
                bottom: auto;
            }

            .container {
                max-width: 100%;
            }
        }

        .header {
            /* Fluid gradient mixing - Apple/Google inspired */
            background:
                radial-gradient(
                    circle at 25% 35%,
                    rgba(167, 148, 224, 0.18) 0%,
                    transparent 45%
                ),
                radial-gradient(
                    circle at 75% 65%,
                    rgba(137, 184, 255, 0.15) 0%,
                    transparent 45%
                ),
                radial-gradient(
                    circle at 50% 50%,
                    rgba(155, 235, 180, 0.12) 0%,
                    transparent 50%
                ),
                linear-gradient(135deg,
                    rgba(10, 14, 39, 0.85) 0%,
                    rgba(26, 30, 63, 0.75) 100%
                );

            color: white;
            padding: 18px 30px;
            text-align: center;
            border-bottom: 1px solid rgba(167, 148, 224, 0.12);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(24px);
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(
                circle at 35% 45%,
                rgba(255, 255, 255, 0.06) 0%,
                transparent 55%
            );
            pointer-events: none;
            opacity: 0.8;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg,
                transparent 0%,
                rgba(218, 165, 32, 0.5) 50%,
                transparent 100%
            );
            box-shadow: 0 0 12px rgba(218, 165, 32, 0.3);
        }

        .header h1 {
            font-size: 22px;
            margin-bottom: 5px;
            font-weight: 700;
            letter-spacing: -0.2px;
            position: relative;
            z-index: 1;

            background: linear-gradient(135deg,
                rgba(255, 255, 255, 0.98) 0%,
                rgba(255, 255, 255, 0.85) 50%,
                rgba(218, 165, 32, 0.9) 100%
            );
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;

            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .header p {
            opacity: 0.75;
            font-size: 12px;
            font-weight: 500;
            letter-spacing: -0.05px;
            position: relative;
            z-index: 1;
            max-width: 800px;
            margin: 0 auto;
            color: rgba(255, 255, 255, 0.7);
        }

        .status {
            background: linear-gradient(180deg,
                rgba(0, 0, 0, 0.25) 0%,
                rgba(0, 0, 0, 0.15) 100%);
            padding: 18px 30px;
            border-bottom: 1px solid rgba(167, 148, 224, 0.12);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            position: relative;
        }

        .status::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg,
                transparent,
                rgba(167, 148, 224, 0.3) 50%,
                transparent
            );
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: linear-gradient(135deg,
                rgba(72, 187, 120, 0.15) 0%,
                rgba(72, 187, 120, 0.08) 100%);
            border: 1px solid rgba(72, 187, 120, 0.35);
            border-radius: 24px;
            box-shadow: 0 2px 8px rgba(72, 187, 120, 0.12),
                        0 1px 3px rgba(0, 0, 0, 0.15),
                        inset 0 1px 1px rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.95);
            font-weight: 500;
            letter-spacing: -0.1px;
            backdrop-filter: blur(8px);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: linear-gradient(135deg, #5edb8b, #48bb78);
            box-shadow: 0 0 8px rgba(72, 187, 120, 0.6),
                        0 0 3px rgba(72, 187, 120, 0.8);
            animation: pulse 2.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.6;
                transform: scale(0.95);
            }
        }

        .chat-container {
            flex: 1;
            min-height: 400px;
            max-height: calc(100vh - 380px);
            overflow-y: auto;
            padding: 30px;
            background: transparent;
            position: relative;
        }

        .chat-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(
                circle at 50% 0%,
                rgba(167, 148, 224, 0.05) 0%,
                transparent 50%
            );
            pointer-events: none;
        }

        .message {
            margin-bottom: 20px;
            animation: messageSlideIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .message.user {
            text-align: right;
        }

        .message-content {
            display: inline-block;
            max-width: 70%;
            padding: 16px 22px;
            border-radius: 18px;
            line-height: 1.7;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            position: relative;
            overflow: hidden;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, var(--gradient-purple), var(--gradient-blue));
            color: white;
            margin-left: auto;
            box-shadow: 0 4px 16px rgba(167, 148, 224, 0.3),
                        0 2px 8px rgba(137, 184, 255, 0.2);
        }

        .message.user .message-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.2),
                transparent
            );
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { left: -100%; }
            50% { left: 100%; }
        }

        .message.assistant .message-content {
            background: linear-gradient(135deg,
                rgba(26, 30, 63, 0.8) 0%,
                rgba(36, 41, 82, 0.7) 100%);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            text-align: left;
            color: rgba(255, 255, 255, 0.95);
        }

        /* Enhanced Markdown Styling */
        .message-content strong {
            color: var(--gold-sacred);
            font-weight: 700;
            text-shadow: 0 0 8px rgba(218, 165, 32, 0.3);
        }

        .message-content code {
            background: rgba(0, 0, 0, 0.4);
            color: var(--gradient-blue);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            border: 1px solid rgba(137, 184, 255, 0.2);
        }

        .message-content h1,
        .message-content h2,
        .message-content h3 {
            background: linear-gradient(90deg, var(--gradient-purple), var(--gradient-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            margin-top: 16px;
            margin-bottom: 8px;
        }

        .sources {
            margin-top: 15px;
            padding: 16px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            font-size: 12px;
        }

        .sources h4 {
            margin-bottom: 12px;
            color: var(--gold-sacred);
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .source-item {
            margin-bottom: 8px;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 3px solid var(--gold-sacred);
            cursor: pointer;
            transition: var(--transition-smooth);
            position: relative;
            overflow: hidden;
        }

        .source-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background: rgba(218, 165, 32, 0.1);
            transition: width 0.3s ease;
        }

        .source-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(6px);
            box-shadow: 0 4px 12px rgba(218, 165, 32, 0.2);
        }

        .source-item:hover::before {
            width: 100%;
        }

        .source-item strong {
            color: var(--gold-sacred);
            position: relative;
            z-index: 1;
        }

        .loading {
            display: inline-flex;
            gap: 6px;
            padding: 16px 22px;
            background: linear-gradient(135deg,
                rgba(26, 30, 63, 0.8) 0%,
                rgba(36, 41, 82, 0.7) 100%);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 18px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gradient-purple), var(--gradient-blue));
            animation: bounce 1.4s ease-in-out infinite;
            box-shadow: 0 0 8px rgba(167, 148, 224, 0.5);
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .input-container {
            padding: 20px 30px;
            background: linear-gradient(180deg,
                rgba(26, 30, 63, 0.95) 0%,
                rgba(36, 41, 82, 0.9) 100%);
            border-top: 1px solid var(--glass-border);
            backdrop-filter: blur(20px);
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
        }

        #queryInput {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid rgba(167, 148, 224, 0.3);
            border-radius: 25px;
            font-size: 15px;
            outline: none;
            transition: var(--transition-smooth);
            font-family: inherit;
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.95);
        }

        #queryInput::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        #queryInput:focus {
            border-color: var(--gradient-purple);
            background: rgba(255, 255, 255, 0.12);
            box-shadow: 0 0 0 3px rgba(167, 148, 224, 0.15),
                        0 4px 20px rgba(167, 148, 224, 0.2);
        }

        #sendButton {
            padding: 15px 30px;
            background: linear-gradient(135deg, var(--gradient-purple), var(--gradient-blue));
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-smooth);
            position: relative;
            overflow: hidden;
        }

        #sendButton::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.2),
                transparent
            );
            transition: left 0.5s ease;
        }

        #sendButton:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(167, 148, 224, 0.4),
                        0 4px 12px rgba(137, 184, 255, 0.3);
        }

        #sendButton:hover:not(:disabled)::before {
            left: 100%;
        }

        #sendButton:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .filter-badge-container {
            margin-bottom: 10px;
            padding: 12px 16px;
            background: rgba(167, 148, 224, 0.1);
            border-radius: 12px;
            border-left: 3px solid var(--gold-sacred);
            backdrop-filter: blur(8px);
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            justify-content: flex-start;
        }

        .filter-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 7px 14px;
            background: linear-gradient(135deg, var(--gradient-purple), var(--gradient-blue));
            border-radius: 20px;
            font-size: 14px;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(167, 148, 224, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .filter-badge-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 16px;
            line-height: 0;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition-smooth);
            flex-shrink: 0;
        }

        .filter-badge-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .autocomplete-dropdown {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 80px;
            background: linear-gradient(180deg,
                rgba(40, 45, 85, 0.98) 0%,
                rgba(35, 40, 75, 0.98) 100%);
            border: 2px solid rgba(167, 148, 224, 0.4);
            border-radius: 14px;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.6),
                        0 4px 16px rgba(167, 148, 224, 0.3),
                        inset 0 1px 1px rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            max-height: 350px;
            overflow-y: auto;
            z-index: 1000;
            margin-bottom: 8px;
        }

        .autocomplete-item {
            padding: 16px 18px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background: linear-gradient(135deg,
                rgba(167, 148, 224, 0.25) 0%,
                rgba(137, 184, 255, 0.2) 100%);
            border-bottom-color: rgba(167, 148, 224, 0.4);
            transform: translateX(3px);
        }

        .autocomplete-item.selected {
            border-left: 4px solid var(--gradient-purple);
            box-shadow: inset 0 0 20px rgba(167, 148, 224, 0.15);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-title {
            font-weight: 700;
            font-size: 15px;
            color: rgba(255, 255, 255, 0.98);
            margin-bottom: 5px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            letter-spacing: -0.2px;
        }

        .autocomplete-id {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.65);
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            font-weight: 500;
            letter-spacing: -0.1px;
        }

        .example-queries {
            margin-top: 15px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .example-query {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(167, 148, 224, 0.2);
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition-smooth);
            color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(8px);
        }

        .example-query:hover {
            background: linear-gradient(135deg, var(--gradient-purple), var(--gradient-blue));
            color: white;
            border-color: transparent;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(167, 148, 224, 0.3);
        }

        .latency {
            margin-top: 5px;
            font-size: 11px;
            color: #718096;
        }

        .followup-button {
            margin-top: 10px;
            padding: 8px 16px;
            background: linear-gradient(135deg, var(--gradient-purple), var(--gradient-blue));
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-smooth);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .followup-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(167, 148, 224, 0.4);
        }

        .followup-button.active {
            background: linear-gradient(135deg, var(--gradient-green), #38a169);
        }

        .followup-indicator {
            padding: 10px 14px;
            background: linear-gradient(135deg,
                rgba(72, 187, 120, 0.2) 0%,
                rgba(56, 161, 105, 0.15) 100%);
            border-left: 3px solid #48bb78;
            border-radius: 10px;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.95);
            font-weight: 500;
            margin-bottom: 12px;
            display: none;
            box-shadow: 0 2px 8px rgba(72, 187, 120, 0.12);
            backdrop-filter: blur(8px);
        }

        .followup-indicator.active {
            display: block;
        }

        .conversation-depth {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 6px;
            font-weight: 500;
        }

        /* ===== METHODOLOGY PANEL ===== */
        .methodology-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 380px;
            height: 100vh;
            background: linear-gradient(135deg,
                rgba(26, 30, 63, 0.85) 0%,
                rgba(36, 41, 82, 0.8) 100%);
            backdrop-filter: blur(16px);
            border-left: 1.5px solid var(--glass-border);
            box-shadow: -20px 0 60px rgba(0, 0, 0, 0.5);
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .methodology-panel.open {
            transform: translateX(0);
        }

        .methodology-toggle {
            position: fixed;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            writing-mode: vertical-rl;
            padding: 16px 10px;
            background: linear-gradient(135deg,
                rgba(26, 30, 63, 0.75) 0%,
                rgba(36, 41, 82, 0.7) 100%);
            border: 1.5px solid rgba(167, 148, 224, 0.35);
            border-right: none;
            border-radius: 12px 0 0 12px;
            color: rgba(255, 255, 255, 0.85);
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: var(--transition-fast);
            z-index: 1001;
        }

        .methodology-toggle:hover {
            background: linear-gradient(135deg,
                var(--gradient-purple) 0%,
                var(--gradient-blue) 100%);
            transform: translateY(-50%) translateX(-2px);
            border-color: rgba(167, 148, 224, 0.6);
        }

        .methodology-toggle:active {
            transform: translateY(-50%) translateX(-1px) scale(0.98);
        }

        .methodology-panel.open ~ .methodology-toggle {
            opacity: 0;
            pointer-events: none;
        }

        .methodology-header {
            padding: 24px 24px 20px 24px;
            border-bottom: 1px solid var(--glass-border);
        }

        .methodology-header h2 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--gradient-purple), var(--gradient-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .methodology-header p {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.5;
        }

        .methodology-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px 24px;
        }

        .methodology-content::-webkit-scrollbar {
            width: 6px;
        }

        .methodology-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        .methodology-content::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--gradient-purple), var(--gradient-blue));
            border-radius: 3px;
        }

        .method-section {
            margin-bottom: 28px;
            padding-bottom: 24px;
            border-bottom: 1px solid rgba(167, 148, 224, 0.15);
        }

        .method-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .method-section h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 12px;
            color: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .method-section p {
            font-size: 15px;
            line-height: 1.7;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 8px;
        }

        .method-section strong {
            color: var(--gradient-blue);
            font-weight: 700;
        }

        .feature-badge {
            display: inline-block;
            padding: 4px 12px;
            background: linear-gradient(135deg,
                rgba(167, 148, 224, 0.2) 0%,
                rgba(137, 184, 255, 0.2) 100%);
            border: 1px solid rgba(167, 148, 224, 0.4);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: var(--gradient-blue);
            margin-top: 8px;
        }

        .pipeline-visual {
            margin: 16px 0;
            padding: 16px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            border: 1px solid rgba(167, 148, 224, 0.2);
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            line-height: 1.8;
            color: rgba(255, 255, 255, 0.9);
            overflow-x: auto;
            white-space: pre-line;
        }

        .methodology-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            font-size: 20px;
            cursor: pointer;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .methodology-close:hover {
            background: rgba(255, 100, 100, 0.2);
            border-color: rgba(255, 100, 100, 0.5);
            color: #ff6b6b;
        }

        /* Left Edge Close Button */
        .methodology-edge-close {
            position: fixed;
            top: 50%;
            left: calc(100vw - 380px);
            transform: translateY(-50%);
            z-index: 1001;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, left 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .methodology-panel.open ~ .methodology-edge-close {
            opacity: 1;
            pointer-events: auto;
            left: calc(100vw - 380px - 20px);
        }

        .edge-close-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 8px;
            background: linear-gradient(135deg,
                rgba(167, 148, 224, 0.25) 0%,
                rgba(137, 184, 255, 0.25) 100%);
            border: 1.5px solid rgba(167, 148, 224, 0.6);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.95);
            font-size: 18px;
            cursor: pointer;
            backdrop-filter: blur(12px);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: -2px 0 12px rgba(0, 0, 0, 0.2);
        }

        .edge-close-btn:hover {
            background: linear-gradient(135deg,
                rgba(167, 148, 224, 0.4) 0%,
                rgba(137, 184, 255, 0.4) 100%);
            border-color: rgba(167, 148, 224, 0.9);
            transform: translateX(-3px);
            box-shadow: -4px 0 16px rgba(167, 148, 224, 0.3);
        }

        .close-icon {
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .edge-close-btn:hover .close-icon {
            transform: translateX(-2px);
        }

        .edge-close-btn:active {
            transform: translateX(-2px) scale(0.98);
        }

        .close-arrow {
            font-size: 18px;
            writing-mode: horizontal-tb;
            transition: transform 0.3s ease;
        }

        .edge-close-btn:hover .close-arrow {
            transform: translateX(3px);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .methodology-panel {
                width: 100%;
                z-index: 2000;
            }

            .methodology-toggle {
                display: none;
            }
        }
    </style>

    <!-- Full-Screen Library Styles -->
    <link rel="stylesheet" href="/css/library.css">
</head>
<body>
    <!-- Source Explorer Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>üìñ Í≤ΩÏ†Ñ ÎùºÏù¥Î∏åÎü¨Î¶¨</h2>
            <p id="sourceCount">Í≤ΩÏ†Ñ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
        </div>
        <div class="sidebar-search">
            <input
                type="text"
                id="sourceSearch"
                placeholder="Í≤ΩÏ†Ñ Í≤ÄÏÉâ..."
                oninput="filterSources()"
            />
            <select id="themeFilter" onchange="filterSources()" style="margin-top: 10px; width: 100%; padding: 8px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px;">
                <option value="">Î™®Îì† Ï£ºÏ†ú</option>
            </select>
            <select id="traditionFilter" onchange="filterSources()" style="margin-top: 10px; width: 100%; padding: 8px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px;">
                <option value="">Î™®Îì† Ï†ÑÌÜµ</option>
            </select>
        </div>
        <div class="sidebar-content" id="sourceList">
            <!-- Source cards will be populated dynamically -->
        </div>
    </div>

    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">
        ‚óÄ
    </button>

    <!-- Main Container -->
    <div class="container">
        <div class="header" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1 style="margin-bottom: 8px;">üôè Î∂àÍµê AI Ï±óÎ¥á</h1>
                <p style="margin: 0;">Fine-tuned BERT ÏûÑÎ≤†Îî© + Gemini 2.5 Pro | CBETA ÎåÄÏû•Í≤Ω 99,723 Î¨∏ÏÑú</p>
            </div>
            <button class="library-header-btn" onclick="openLibrary()" aria-label="Í≤ΩÏ†Ñ ÎùºÏù¥Î∏åÎü¨Î¶¨ Ïó¥Í∏∞">
                üìö Í≤ΩÏ†Ñ ÎùºÏù¥Î∏åÎü¨Î¶¨
            </button>
        </div>

        <div class="status">
            <div class="status-badge">
                <div class="status-dot"></div>
                <span>ÏÑúÎ≤Ñ Ïó∞Í≤∞Îê®</span>
            </div>
            <div style="color: #718096;">
                <span id="modelInfo">Model: Gemini 2.5 Pro | Embeddings: Gemini 3072-dim</span>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="message assistant">
                <div class="message-content">
                    ÏïàÎÖïÌïòÏÑ∏Ïöî! Ï†ÄÎäî CBETA ÎåÄÏû•Í≤ΩÏùÑ Í∏∞Î∞òÏúºÎ°ú Ìïú Î∂àÍµê AI Ï±óÎ¥áÏûÖÎãàÎã§.<br><br>
                    Í∂ÅÍ∏àÌïòÏã† Î∂àÍµê ÍµêÎ¶¨ÎÇò Í≤ΩÏ†Ñ ÎÇ¥Ïö©ÏùÑ ÏßàÎ¨∏Ìï¥ Ï£ºÏÑ∏Ïöî. Ï†ïÌôïÌïú Ï∂úÏ≤òÏôÄ Ìï®Íªò ÎãµÎ≥ÄÎìúÎ¶¨Í≤†ÏäµÎãàÎã§.
                </div>
            </div>
        </div>

        <div class="input-container">
            <!-- Follow-up indicator -->
            <div id="followupIndicator" class="followup-indicator">
                <span>‚Ü©Ô∏è ÌõÑÏÜç ÏßàÎ¨∏ Î™®Îìú ÌôúÏÑ±Ìôî</span>
                <button class="filter-badge-close" onclick="deactivateFollowup()">√ó</button>
            </div>

            <!-- Combined badges container for detailed mode and sutra filter -->
            <div id="filterBadgesContainer" class="filter-badge-container" style="display: none;">
                <div id="detailedModeBadge" class="filter-badge" style="display: none;">
                    <span>üîç ÏûêÏÑ∏Ìûà Î™®Îìú</span>
                    <button class="filter-badge-close" onclick="clearDetailedMode()">√ó</button>
                </div>
                <div id="sutraFilterBadge" class="filter-badge" style="display: none;">
                    <span id="sutraFilterText"></span>
                    <button class="filter-badge-close" onclick="clearSutraFilter()">√ó</button>
                </div>
            </div>
            <div class="input-wrapper" style="position: relative;">
                <input
                    type="text"
                    id="queryInput"
                    placeholder="Î∂àÍµê ÍµêÎ¶¨Ïóê ÎåÄÌï¥ ÏßàÎ¨∏Ìï¥ Ï£ºÏÑ∏Ïöî... (Ïòà: ÏÇ¨ÏÑ±Ï†úÎûÄ Î¨¥ÏóáÏù∏Í∞ÄÏöî? ÎòêÎäî /Ïû•ÏïÑÌï®Í≤Ω)"
                    onkeypress="if(event.key === 'Enter' && !autocompleteVisible) sendQuery()"
                    onkeydown="handleAutocompleteKeyboard(event)"
                    oninput="handleSlashCommand()"
                />
                <button id="sendButton" onclick="sendQuery()">Ï†ÑÏÜ°</button>
                <div id="autocompleteDropdown" class="autocomplete-dropdown" style="display: none;"></div>
            </div>
            <div class="example-queries">
                <div class="example-query" onclick="setQuery('ÏÇ¨ÏÑ±Ï†úÎûÄ Î¨¥ÏóáÏù∏Í∞ÄÏöî?')">ÏÇ¨ÏÑ±Ï†ú</div>
                <div class="example-query" onclick="setQuery('ÌåîÏ†ïÎèÑÏóê ÎåÄÌï¥ ÏÑ§Î™ÖÌï¥Ï£ºÏÑ∏Ïöî')">ÌåîÏ†ïÎèÑ</div>
                <div class="example-query" onclick="setQuery('Î¨¥ÏÉÅ(ÁÑ°Â∏∏)Ïùò ÏùòÎØ∏Îäî?')">Î¨¥ÏÉÅ(ÁÑ°Â∏∏)</div>
                <div class="example-query" onclick="setQuery('Ïó∞Í∏∞Î≤ïÏù¥ÎûÄ Î¨¥ÏóáÏù∏Í∞ÄÏöî?')">Ïó∞Í∏∞Î≤ï</div>
                <div class="example-query" onclick="setQuery('ÏûêÎπÑÏôÄ ÏßÄÌòúÏùò Í¥ÄÍ≥Ñ')">ÏûêÎπÑÏôÄ ÏßÄÌòú</div>
                <div class="example-query" onclick="setQuery('Ïö∞Ï£ºÎ°†Í≥º ÏÇºÍ≥ÑÏóê ÎåÄÌï¥ ÏÑ§Î™ÖÌï¥Ï§ò')">Ïö∞Ï£ºÎ°†Í≥º ÏÇºÍ≥Ñ</div>
            </div>
        </div>
    </div>

    <!-- Source Detail Modal -->
    <div class="modal" id="sourceModal" onclick="if(event.target === this) closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <!-- Previous Button -->
            <button class="modal-nav-button prev" id="modalPrevBtn" onclick="navigateModal(-1)" title="Ïù¥Ï†Ñ Í≤ΩÏ†Ñ (‚Üê)" aria-label="Ïù¥Ï†Ñ Í≤ΩÏ†Ñ"></button>

            <!-- Next Button -->
            <button class="modal-nav-button next" id="modalNextBtn" onclick="navigateModal(1)" title="Îã§Ïùå Í≤ΩÏ†Ñ (‚Üí)" aria-label="Îã§Ïùå Í≤ΩÏ†Ñ"></button>

            <div class="modal-scroll-wrapper">
                <div class="modal-header">
                    <button class="modal-close" onclick="closeModal()">√ó</button>
                    <h3 id="modalTitle">Í≤ΩÏ†Ñ Ï†úÎ™©</h3>
                    <p id="modalMeta">Ï†ÄÏûê | ÏãúÎåÄ | Ï†ÑÌÜµ</p>
                </div>
                <div class="modal-body">
                    <div class="modal-section">
                        <h4>üìú Í∞ÑÎûµ ÏöîÏïΩ</h4>
                        <p id="modalBriefSummary"></p>
                    </div>
                    <div class="modal-section">
                        <h4>üìñ ÏÉÅÏÑ∏ ÏöîÏïΩ</h4>
                        <p id="modalDetailedSummary"></p>
                    </div>
                    <div class="modal-section">
                        <h4>üîë ÌïµÏã¨ Ï£ºÏ†ú</h4>
                        <div class="modal-themes" id="modalThemes"></div>
                    </div>
                    <div class="modal-section">
                        <h4>üìö ÏõêÎ¨∏ Ï†ïÎ≥¥</h4>
                        <p id="modalOriginalInfo"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== Source Explorer =====
        let allSources = [];
        let filteredSources = [];
        let currentModalIndex = -1; // Track current modal index for navigation
        let activeFilters = {
            tradition: null,
            period: null
        };

        // Load sources on page load
        // Load metadata for filters
        async function loadMetadata() {
            try {
                // Use relative URL for production compatibility
                const response = await fetch('/api/sutras/meta');
                if (!response.ok) throw new Error('Failed to load metadata');

                const metadata = await response.json();

                // Store globally for library.js
                window.libraryMetadata = metadata;

                // Populate theme dropdown (sidebar)
                const themeSelect = document.getElementById('themeFilter');
                metadata.themes.slice(0, 100).forEach(theme => {
                    const option = document.createElement('option');
                    option.value = theme;
                    option.textContent = theme;
                    themeSelect.appendChild(option);
                });

                // Populate tradition dropdown (sidebar)
                const traditionSelect = document.getElementById('traditionFilter');
                metadata.traditions.forEach(tradition => {
                    const option = document.createElement('option');
                    option.value = tradition;
                    option.textContent = tradition;
                    traditionSelect.appendChild(option);
                });

                // Notify library.js that metadata is loaded
                if (window.onLibraryMetadataLoaded) {
                    window.onLibraryMetadataLoaded(metadata);
                }
            } catch (error) {
                console.error('Error loading metadata:', error);
            }
        }

        async function loadSources() {
            try {
                const response = await fetch('http://localhost:8000/api/sources?limit=2500');
                if (!response.ok) throw new Error('Failed to load sources');

                const data = await response.json();
                allSources = data.sources;
                filteredSources = [...allSources];

                document.getElementById('sourceCount').textContent =
                    `Ï¥ù ${data.total.toLocaleString()}Í∞ú Í≤ΩÏ†Ñ (${data.sources.length}Í∞ú ÌëúÏãú)`;

                renderSources();
            } catch (error) {
                console.error('Error loading sources:', error);
                document.getElementById('sourceCount').textContent = 'Í≤ΩÏ†Ñ Î°úÎî© Ïã§Ìå®';
            }
        }

        // Render source cards
        function renderSources() {
            const sourceList = document.getElementById('sourceList');

            if (filteredSources.length === 0) {
                sourceList.innerHTML = '<div style="padding:20px;text-align:center;color:#718096;">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</div>';
                return;
            }

            sourceList.innerHTML = filteredSources.map(source => `
                <div class="source-card" onclick="showSourceDetail('${source.sutra_id}')">
                    <div class="source-card-title">${source.title_ko || source.original_title}</div>
                    <div class="source-card-summary">${source.brief_summary || 'ÏöîÏïΩ Ï†ïÎ≥¥ ÏóÜÏùå'}</div>
                    <div class="source-card-meta">
                        ${source.tradition ? `<span class="source-tag">${source.tradition}</span>` : ''}
                        ${source.period ? `<span class="source-tag">${source.period}</span>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Filter sources by search term, theme, and tradition
        function filterSources() {
            const searchTerm = document.getElementById('sourceSearch').value.toLowerCase();
            const selectedTheme = document.getElementById('themeFilter').value;
            const selectedTradition = document.getElementById('traditionFilter').value;

            filteredSources = allSources.filter(source => {
                // Search filter
                const matchesSearch = !searchTerm ||
                    source.title_ko?.toLowerCase().includes(searchTerm) ||
                    source.original_title?.toLowerCase().includes(searchTerm) ||
                    source.brief_summary?.toLowerCase().includes(searchTerm);

                // Theme filter
                const matchesTheme = !selectedTheme ||
                    (source.key_themes && (
                        (Array.isArray(source.key_themes) && source.key_themes.includes(selectedTheme)) ||
                        source.key_themes === selectedTheme
                    ));

                // Tradition filter
                const matchesTradition = !selectedTradition ||
                    source.tradition === selectedTradition;

                return matchesSearch && matchesTheme && matchesTradition;
            });

            document.getElementById('sourceCount').textContent =
                `Ï¥ù ${allSources.length.toLocaleString()}Í∞ú Í≤ΩÏ†Ñ (${filteredSources.length}Í∞ú ÌëúÏãú)`;

            renderSources();
        }

        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggle = document.getElementById('sidebarToggle');

            sidebar.classList.toggle('collapsed');
            toggle.textContent = sidebar.classList.contains('collapsed') ? '‚ñ∂' : '‚óÄ';
        }

        // Show source detail modal
        async function showSourceDetail(sutraId) {
            try {
                // Find current index in filteredSources (for navigation)
                // Try sidebar sources first, then library sources
                currentModalIndex = filteredSources.findIndex(s => s.sutra_id === sutraId);
                if (currentModalIndex === -1 && window.libraryState) {
                    // If not in sidebar, use library sources for navigation
                    currentModalIndex = window.libraryState.filteredCards.findIndex(s => s.sutra_id === sutraId);
                }

                const response = await fetch(`/api/sources/${sutraId}`);
                if (!response.ok) throw new Error('Failed to load source detail');

                const source = await response.json();

                // Populate modal
                document.getElementById('modalTitle').textContent = source.title_ko || source.original_title;
                document.getElementById('modalMeta').textContent =
                    `${source.author || 'ÏûëÏûê ÎØ∏ÏÉÅ'} | ${source.period || 'ÏãúÎåÄ ÎØ∏ÏÉÅ'} | ${source.tradition || 'Ï†ÑÌÜµ ÎØ∏ÏÉÅ'}`;
                document.getElementById('modalBriefSummary').textContent = source.brief_summary || 'ÏöîÏïΩ Ï†ïÎ≥¥ ÏóÜÏùå';
                document.getElementById('modalDetailedSummary').textContent = source.detailed_summary || 'ÏÉÅÏÑ∏ ÏöîÏïΩ Ï†ïÎ≥¥ ÏóÜÏùå';

                // Themes
                const themesContainer = document.getElementById('modalThemes');
                if (source.key_themes && source.key_themes.length > 0) {
                    themesContainer.innerHTML = source.key_themes.map(theme =>
                        `<span class="theme-tag">${theme}</span>`
                    ).join('');
                } else {
                    themesContainer.innerHTML = '<span style="color:#718096;font-size:12px;">Ï£ºÏ†ú Ï†ïÎ≥¥ ÏóÜÏùå</span>';
                }

                // Original info
                document.getElementById('modalOriginalInfo').innerHTML = `
                    <strong>ÏõêÏ†úÎ™©:</strong> ${source.original_title}<br>
                    <strong>Ï†ÄÏûê:</strong> ${source.author || 'ÎØ∏ÏÉÅ'}<br>
                    <strong>ÎåÄÏû•Í≤Ω Î≤àÌò∏:</strong> ${sutraId}<br>
                    <strong>Í∂åÏàò:</strong> Ï†ú${source.volume}Í∂å Ï†ú${source.juan}
                `;

                // Show modal
                document.getElementById('sourceModal').classList.add('active');

                // Update navigation button states
                updateModalNavButtons();
            } catch (error) {
                console.error('Error loading source detail:', error);
                alert('Í≤ΩÏ†Ñ ÏÉÅÏÑ∏ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('sourceModal').classList.remove('active');
            currentModalIndex = -1;
        }

        // Navigate modal (direction: -1 for previous, 1 for next)
        function navigateModal(direction) {
            const newIndex = currentModalIndex + direction;

            // Boundary check
            if (newIndex < 0 || newIndex >= filteredSources.length) {
                return;
            }

            // Navigate to new source
            const newSource = filteredSources[newIndex];
            showSourceDetail(newSource.sutra_id);
        }

        // Update navigation button states
        function updateModalNavButtons() {
            const prevBtn = document.getElementById('modalPrevBtn');
            const nextBtn = document.getElementById('modalNextBtn');

            // Disable prev if at start
            if (currentModalIndex <= 0) {
                prevBtn.disabled = true;
            } else {
                prevBtn.disabled = false;
            }

            // Disable next if at end
            if (currentModalIndex >= filteredSources.length - 1) {
                nextBtn.disabled = true;
            } else {
                nextBtn.disabled = false;
            }
        }

        // Global keyboard event handler for modal navigation
        document.addEventListener('keydown', (e) => {
            const modal = document.getElementById('sourceModal');
            const isModalOpen = modal.classList.contains('active');

            if (!isModalOpen) return;

            // ESC to close
            if (e.key === 'Escape') {
                closeModal();
                e.preventDefault();
            }

            // Arrow Left for previous
            if (e.key === 'ArrowLeft') {
                navigateModal(-1);
                e.preventDefault();
            }

            // Arrow Right for next
            if (e.key === 'ArrowRight') {
                navigateModal(1);
                e.preventDefault();
            }
        });

        // ===== Chat Functionality =====
        const API_URL = 'http://localhost:8000/api/chat';
        const chatContainer = document.getElementById('chatContainer');
        const queryInput = document.getElementById('queryInput');
        const sendButton = document.getElementById('sendButton');

        // Slash command state
        let currentSutraFilter = null;
        let detailedModeActive = false;
        let autocompleteVisible = false;
        let selectedAutocompleteIndex = -1;

        // Follow-up state
        let activeSessionId = null;
        let activeConversationDepth = 0;

        function setQuery(text) {
            queryInput.value = text;
            queryInput.focus();
        }

        // Handle slash command input
        function handleSlashCommand() {
            const value = queryInput.value;
            const dropdown = document.getElementById('autocompleteDropdown');

            // Check if input starts with /
            if (value.startsWith('/')) {
                const searchTerm = value.substring(1).toLowerCase();

                // Special commands (ÏûêÏÑ∏Ìûà detailed mode)
                const specialCommands = [
                    { command: 'ÏûêÏÑ∏Ìûà', description: 'ÏÉÅÏÑ∏ÌïòÍ≥† Ìè¨Í¥ÑÏ†ÅÏù∏ ÎãµÎ≥Ä', color: '#9b59b6' }
                ];

                // Filter special commands
                const matchingCommands = specialCommands.filter(cmd =>
                    cmd.command.toLowerCase().includes(searchTerm)
                );

                // Filter sources matching the search term
                const matchingSources = allSources.filter(source => {
                    return source.title_ko.toLowerCase().includes(searchTerm) ||
                           source.original_title.toLowerCase().includes(searchTerm) ||
                           source.sutra_id.toLowerCase().includes(searchTerm);
                }).slice(0, 8); // Limit to 8 results

                const matches = [...matchingCommands.map(cmd => ({ type: 'command', data: cmd })),
                                 ...matchingSources.map(src => ({ type: 'source', data: src }))];

                if (matches.length > 0) {
                    // Reset selection index when list changes
                    selectedAutocompleteIndex = -1;

                    // Show dropdown with matches
                    dropdown.innerHTML = matches.map(match => {
                        if (match.type === 'command') {
                            return `
                                <div class="autocomplete-item" onclick="selectDetailedMode()" style="border-left: 3px solid ${match.data.color};">
                                    <div class="autocomplete-title" style="color: ${match.data.color};">/${match.data.command}</div>
                                    <div class="autocomplete-id">${match.data.description}</div>
                                </div>
                            `;
                        } else {
                            return `
                                <div class="autocomplete-item" onclick="selectSutra('${match.data.sutra_id}', '${match.data.title_ko.replace(/'/g, "\\'")}')">
                                    <div class="autocomplete-title">${match.data.title_ko}</div>
                                    <div class="autocomplete-id">${match.data.sutra_id} ‚Ä¢ ${match.data.volume}</div>
                                </div>
                            `;
                        }
                    }).join('');
                    dropdown.style.display = 'block';
                    autocompleteVisible = true;
                } else {
                    dropdown.style.display = 'none';
                    autocompleteVisible = false;
                }
            } else {
                // Hide dropdown if not a slash command
                dropdown.style.display = 'none';
                autocompleteVisible = false;
            }
        }

        // Handle keyboard navigation in autocomplete
        function handleAutocompleteKeyboard(event) {
            if (!autocompleteVisible) return;

            const dropdown = document.getElementById('autocompleteDropdown');
            const items = dropdown.querySelectorAll('.autocomplete-item');

            if (items.length === 0) return;

            // Handle arrow keys
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                selectedAutocompleteIndex = (selectedAutocompleteIndex + 1) % items.length;
                updateAutocompleteSelection(items);
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                selectedAutocompleteIndex = (selectedAutocompleteIndex - 1 + items.length) % items.length;
                updateAutocompleteSelection(items);
            } else if (event.key === 'Enter' && selectedAutocompleteIndex >= 0) {
                event.preventDefault();
                items[selectedAutocompleteIndex].click();
            }
        }

        // Update visual selection in autocomplete
        function updateAutocompleteSelection(items) {
            items.forEach((item, index) => {
                if (index === selectedAutocompleteIndex) {
                    item.classList.add('selected');
                    item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        // Select detailed mode
        function selectDetailedMode() {
            detailedModeActive = true;

            // Clear input and hide dropdown
            queryInput.value = '';
            document.getElementById('autocompleteDropdown').style.display = 'none';
            autocompleteVisible = false;

            // Show detailed mode badge
            const detailedBadge = document.getElementById('detailedModeBadge');
            const filterBadgesContainer = document.getElementById('filterBadgesContainer');
            filterBadgesContainer.style.display = 'flex';
            detailedBadge.style.display = 'block';
            detailedBadge.style.background = 'linear-gradient(135deg, #9b59b615 0%, #9b59b615 100%)';
            detailedBadge.style.borderLeft = '3px solid #9b59b6';

            // Update input styling based on active modes
            updateInputStyling();

            // Focus input
            queryInput.focus();
        }

        // Clear detailed mode
        function clearDetailedMode() {
            detailedModeActive = false;
            document.getElementById('detailedModeBadge').style.display = 'none';

            // Hide parent container if both badges are hidden
            const sutraBadge = document.getElementById('sutraFilterBadge');
            if (sutraBadge.style.display === 'none') {
                document.getElementById('filterBadgesContainer').style.display = 'none';
            }

            updateInputStyling();
        }

        // Select a sutra from autocomplete
        function selectSutra(sutraId, sutraTitle) {
            currentSutraFilter = sutraId;

            // Clear input and hide dropdown
            queryInput.value = '';
            document.getElementById('autocompleteDropdown').style.display = 'none';
            autocompleteVisible = false;

            // Show sutra filter badge
            const sutraBadge = document.getElementById('sutraFilterBadge');
            const filterBadgesContainer = document.getElementById('filterBadgesContainer');
            const sutraText = document.getElementById('sutraFilterText');
            filterBadgesContainer.style.display = 'flex';
            sutraText.textContent = `ÌïÑÌÑ∞: ${sutraTitle}`;
            sutraBadge.style.display = 'block';
            sutraBadge.style.background = 'linear-gradient(135deg, #667eea15 0%, #764ba215 100%)';
            sutraBadge.style.borderLeft = '3px solid #667eea';

            // Update input styling based on active modes
            updateInputStyling();

            // Focus input
            queryInput.focus();
        }

        // Clear sutra filter
        function clearSutraFilter() {
            currentSutraFilter = null;
            document.getElementById('sutraFilterBadge').style.display = 'none';

            // Hide parent container if both badges are hidden
            const detailedBadge = document.getElementById('detailedModeBadge');
            if (detailedBadge.style.display === 'none') {
                document.getElementById('filterBadgesContainer').style.display = 'none';
            }

            updateInputStyling();
        }

        // Update input border styling based on active modes
        function updateInputStyling() {
            if (detailedModeActive && currentSutraFilter) {
                // Both modes active - use a gradient border
                queryInput.style.borderColor = '#667eea';
                queryInput.style.boxShadow = '0 0 0 3px rgba(155, 89, 182, 0.1)';
            } else if (detailedModeActive) {
                // Only detailed mode
                queryInput.style.borderColor = '#9b59b6';
                queryInput.style.boxShadow = '0 0 0 3px rgba(155, 89, 182, 0.1)';
            } else if (currentSutraFilter) {
                // Only sutra filter
                queryInput.style.borderColor = '#667eea';
                queryInput.style.boxShadow = '0 0 0 3px rgba(102, 126, 234, 0.1)';
            } else {
                // No modes active
                queryInput.style.borderColor = '';
                queryInput.style.boxShadow = '';
            }
        }

        async function sendQuery() {
            let query = queryInput.value.trim();
            if (!query) return;

            // Detect /ÏûêÏÑ∏Ìûà prefix for detailed mode OR check if detailed mode is active
            let detailedMode = detailedModeActive;
            if (query.startsWith('/ÏûêÏÑ∏Ìûà ')) {
                detailedMode = true;
                query = query.substring(5).trim(); // Remove "/ÏûêÏÑ∏Ìûà " prefix
            }

            // Add user message (show original query with prefix if used)
            addMessage(queryInput.value.trim(), 'user');
            queryInput.value = '';
            sendButton.disabled = true;

            // Note: Do NOT clear detailed mode after sending
            // It should persist until user manually closes the badge

            // Show loading
            const loadingId = showLoading();

            try {
                // Build request body with optional sutra filter, detailed mode, and follow-up
                const requestBody = { query };
                if (currentSutraFilter) {
                    requestBody.sutra_filter = currentSutraFilter;
                }
                if (detailedMode) {
                    requestBody.detailed_mode = true;
                }
                if (activeSessionId) {
                    requestBody.session_id = activeSessionId;
                    requestBody.is_followup = true;
                }

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // Remove loading
                removeLoading(loadingId);

                // Add assistant response with session info and cache status
                addMessage(data.response, 'assistant', data.sources, data.latency_ms, data.session_id, data.conversation_depth, data.from_cache);

            } catch (error) {
                removeLoading(loadingId);
                addMessage(`Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${error.message}`, 'assistant');
            } finally {
                sendButton.disabled = false;
                queryInput.focus();
            }
        }

        function parseMarkdown(text) {
            // Split into paragraphs
            let html = text.split('\n\n').map(paragraph => {
                // Check if it's a numbered list
                if (/^\d+\.\s/.test(paragraph)) {
                    const items = paragraph.split('\n').filter(line => /^\d+\.\s/.test(line));
                    const listItems = items.map(item => {
                        const content = item.replace(/^\d+\.\s+/, '');
                        return `<li>${formatInlineMarkdown(content)}</li>`;
                    }).join('');
                    return `<ol>${listItems}</ol>`;
                }

                // Check if it's a bullet list
                if (/^[-*‚Ä¢]\s/.test(paragraph)) {
                    const items = paragraph.split('\n').filter(line => /^[-*‚Ä¢]\s/.test(line));
                    const listItems = items.map(item => {
                        const content = item.replace(/^[-*‚Ä¢]\s+/, '');
                        return `<li>${formatInlineMarkdown(content)}</li>`;
                    }).join('');
                    return `<ul>${listItems}</ul>`;
                }

                // Check if it's a heading
                if (paragraph.startsWith('### ')) {
                    return `<h4>${formatInlineMarkdown(paragraph.substring(4))}</h4>`;
                }
                if (paragraph.startsWith('## ')) {
                    return `<h3>${formatInlineMarkdown(paragraph.substring(3))}</h3>`;
                }

                // Regular paragraph
                return `<p>${formatInlineMarkdown(paragraph)}</p>`;
            }).join('');

            return html;
        }

        function formatInlineMarkdown(text) {
            // Bold: **text** or __text__
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/__(.+?)__/g, '<strong>$1</strong>');

            // Code or inline formatting with backticks
            text = text.replace(/`(.+?)`/g, '<code>$1</code>');

            // Single line breaks
            text = text.replace(/\n/g, '<br>');

            return text;
        }

        function addMessage(content, role, sources = null, latency = null, sessionId = null, conversationDepth = null, fromCache = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            // Add cache badge if this is a cached response
            if (role === 'assistant' && fromCache) {
                const cacheBadge = document.createElement('div');
                cacheBadge.style.cssText = 'display: inline-block; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-bottom: 12px;';
                cacheBadge.innerHTML = 'üíæ Ï∫êÏãúÎêú ÎãµÎ≥Ä (Ï†ÄÏû•Îêú Í≥†ÌíàÏßà ÎãµÎ≥Ä)';
                contentDiv.appendChild(cacheBadge);
            }

            // Parse markdown for assistant messages
            if (role === 'assistant') {
                const textDiv = document.createElement('div');
                textDiv.innerHTML = parseMarkdown(content);
                contentDiv.appendChild(textDiv);
            } else {
                contentDiv.textContent = content;
            }

            if (sources && sources.length > 0) {
                const sourcesDiv = document.createElement('div');
                sourcesDiv.className = 'sources';
                sourcesDiv.innerHTML = '<h4>üìö Ï∂úÏ≤ò (Sources):</h4>';

                sources.forEach((source, idx) => {
                    const sourceItem = document.createElement('div');
                    sourceItem.className = 'source-item';
                    sourceItem.style.cursor = 'pointer';
                    sourceItem.innerHTML = `<strong>${idx + 1}. ${source.title}</strong> (${source.text_id})<br>${source.excerpt.substring(0, 100)}...`;
                    sourceItem.onclick = () => showSourceDetail(source.text_id);
                    sourcesDiv.appendChild(sourceItem);
                });

                if (latency) {
                    const latencyDiv = document.createElement('div');
                    latencyDiv.className = 'latency';
                    latencyDiv.textContent = `‚ö° ÏùëÎãµ ÏãúÍ∞Ñ: ${latency}ms`;
                    sourcesDiv.appendChild(latencyDiv);
                }

                contentDiv.appendChild(sourcesDiv);
            }

            // Add follow-up button for assistant messages
            if (role === 'assistant' && sessionId) {
                const followupBtn = document.createElement('button');
                followupBtn.className = 'followup-button';
                followupBtn.innerHTML = '‚Ü©Ô∏è Ïù¥ ÎãµÎ≥ÄÏóê ÎåÄÌï¥ Îçî ÏßàÎ¨∏ÌïòÍ∏∞';
                followupBtn.onclick = () => activateFollowup(sessionId, conversationDepth);

                // Show conversation depth
                if (conversationDepth) {
                    const depthDiv = document.createElement('div');
                    depthDiv.className = 'conversation-depth';
                    depthDiv.textContent = `ÎåÄÌôî ÍπäÏù¥: ${conversationDepth}`;
                    contentDiv.appendChild(depthDiv);
                }

                contentDiv.appendChild(followupBtn);
            }

            messageDiv.appendChild(contentDiv);
            chatContainer.appendChild(messageDiv);

            // Scroll to show the top of the message (not the bottom)
            messageDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function showLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message assistant';
            loadingDiv.id = 'loading-' + Date.now();

            loadingDiv.innerHTML = `
                <div class="loading">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            `;

            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return loadingDiv.id;
        }

        function removeLoading(id) {
            const loadingDiv = document.getElementById(id);
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        // Follow-up functions
        function activateFollowup(sessionId, depth) {
            // Deactivate any previous follow-up buttons
            document.querySelectorAll('.followup-button.active').forEach(btn => {
                btn.classList.remove('active');
                btn.innerHTML = '‚Ü©Ô∏è Ïù¥ ÎãµÎ≥ÄÏóê ÎåÄÌï¥ Îçî ÏßàÎ¨∏ÌïòÍ∏∞';
            });

            // Activate the clicked button
            event.target.classList.add('active');
            event.target.innerHTML = '‚úì ÌõÑÏÜç ÏßàÎ¨∏ Î™®Îìú ÌôúÏÑ±ÌôîÎê®';

            // Set active session
            activeSessionId = sessionId;
            activeConversationDepth = depth;

            // Show indicator
            const indicator = document.getElementById('followupIndicator');
            indicator.classList.add('active');
            indicator.querySelector('span').textContent = `‚Ü©Ô∏è ÌõÑÏÜç ÏßàÎ¨∏ Î™®Îìú (ÎåÄÌôî ÍπäÏù¥: ${depth})`;

            // Focus input
            queryInput.focus();
        }

        function deactivateFollowup() {
            // Clear active session
            activeSessionId = null;
            activeConversationDepth = 0;

            // Hide indicator
            document.getElementById('followupIndicator').classList.remove('active');

            // Deactivate all buttons
            document.querySelectorAll('.followup-button.active').forEach(btn => {
                btn.classList.remove('active');
                btn.innerHTML = '‚Ü©Ô∏è Ïù¥ ÎãµÎ≥ÄÏóê ÎåÄÌï¥ Îçî ÏßàÎ¨∏ÌïòÍ∏∞';
            });
        }

        // ===== Initialize on Page Load =====
        window.addEventListener('DOMContentLoaded', async () => {
            await loadMetadata();
            loadSources();

            // Load methodology panel state from localStorage
            const methodologyOpen = localStorage.getItem('methodologyPanelOpen') === 'true';
            if (methodologyOpen) {
                document.getElementById('methodologyPanel').classList.add('open');
            }
        });

        // ===== Methodology Panel Toggle =====
        function toggleMethodologyPanel() {
            const panel = document.getElementById('methodologyPanel');
            panel.classList.toggle('open');

            // Save state to localStorage
            const isOpen = panel.classList.contains('open');
            localStorage.setItem('methodologyPanelOpen', isOpen);
        }

        // Keyboard shortcut: Shift+M
        document.addEventListener('keydown', (e) => {
            if (e.shiftKey && e.key === 'M') {
                toggleMethodologyPanel();
                e.preventDefault();
            }
        });
    </script>

    <!-- Methodology Panel -->
    <div class="methodology-panel" id="methodologyPanel">
        <button class="methodology-close" onclick="toggleMethodologyPanel()" aria-label="Ìå®ÎÑê Îã´Í∏∞">√ó</button>

        <div class="methodology-header">
            <h2>ü§ñ Ïö∞Î¶¨Ïùò Î∞©Î≤ïÎ°†</h2>
            <p>CBETA ÎåÄÏû•Í≤ΩÎ∂ÄÌÑ∞ AI ÎãµÎ≥ÄÍπåÏßÄ, Ï†ÑÏ≤¥ ÌîÑÎ°úÏÑ∏Ïä§Î•º Ìà¨Î™ÖÌïòÍ≤å Í≥µÍ∞úÌï©ÎãàÎã§</p>
        </div>

        <div class="methodology-content">
            <section class="method-section">
                <h3>üìö CBETA ÎåÄÏ†ïÏã†ÏàòÎåÄÏû•Í≤Ω (T)</h3>
                <p>Ï†ÑÏûêÎ∂àÏ†ÑÎ¨∏ÌôîÏû¨Îã®(CBETA)Ïùò <strong>ÎåÄÏ†ïÏã†ÏàòÎåÄÏû•Í≤Ω(Taish≈ç Tripi·π≠aka)</strong> Ïª¨Î†âÏÖòÏùÑ ÏÇ¨Ïö©Ìï©ÎãàÎã§.</p>
                <p>CBETA Ï†ÑÏ≤¥Í∞Ä ÏïÑÎãå, <strong>T Ìè¥ÎçîÏùò Í≤ΩÏ†ÑÎßå</strong> ÏÑ†Î≥ÑÌïòÏó¨ ÎÜíÏùÄ ÌíàÏßàÏùò Îç∞Ïù¥ÌÑ∞Î•º ÌôïÎ≥¥ÌñàÏäµÎãàÎã§.</p>
                <div class="feature-badge" title="ÎåÄÏ†ïÏã†ÏàòÎåÄÏû•Í≤Ω T Ìè¥Îçî">99,723Í∞ú Ï≤≠ÌÅ¨</div>
            </section>


            <section class="method-section">
                <h3>üíæ 2Í∞ÄÏßÄ ÏûÑÎ≤†Îî© Î™®Îç∏Î°ú Î¨∏ÏÑú ÏûÑÎ≤†Îî©</h3>
                <p><strong>üìö BAAI/bge-m3 (1024 Ï∞®Ïõê)</strong><br>
                Í≥†Ï†Ñ ÌïúÎ¨∏ ÌäπÌôî Î™®Îç∏Î°ú CBETA ÎåÄÏû•Í≤Ω Ï†ÑÏ≤¥Î•º ÏûÑÎ≤†Îî©ÌñàÏäµÎãàÎã§.</p>

                <p><strong>üîç Google Gemini (3072 Ï∞®Ïõê) - ÌòÑÏû¨ ÏÇ¨Ïö© Ï§ë</strong><br>
                gemini-embedding-001 Î™®Îç∏Î°ú CBETA ÎåÄÏû•Í≤Ω Ï†ÑÏ≤¥(99,723Í∞ú Ï≤≠ÌÅ¨)Î•º Ïû¨ÏûÑÎ≤†Îî©ÌïòÏó¨ ChromaDBÏóê Ï†ÄÏû•ÌñàÏäµÎãàÎã§.<br>
                ÏÇ¨Ïö©Ïûê ÏßàÎ¨∏ÎèÑ ÎèôÏùºÌïú Gemini Î™®Îç∏Î°ú Ïã§ÏãúÍ∞Ñ ÏûÑÎ≤†Îî©ÌïòÏó¨ ÏùòÎØ∏ Í∏∞Î∞ò Í≤ÄÏÉâÏùÑ ÏàòÌñâÌï©ÎãàÎã§.</p>

                <p>Î≤°ÌÑ∞ Í≥µÍ∞ÑÏóêÏÑú ÏßàÎ¨∏Í≥º <strong>ÏùòÎØ∏Í∞Ä Ïú†ÏÇ¨Ìïú Í≤ΩÏ†Ñ</strong>ÏùÑ Î∞ÄÎ¶¨Ï¥à Îã®ÏúÑÎ°ú Í≤ÄÏÉâÌï©ÎãàÎã§.</p>
                <div class="feature-badge" title="ÌòÑÏû¨ Í≤ÄÏÉâ Í∞ÄÎä•Ìïú Ï≤≠ÌÅ¨ Ïàò">üîç 99,723Í∞ú Ï≤≠ÌÅ¨ Í≤ÄÏÉâ Í∞ÄÎä•</div>
                <div class="feature-badge" title="ÌòÑÏû¨ ÏÇ¨Ïö© Ï§ëÏù∏ ÏûÑÎ≤†Îî©">3072-dim (Gemini)</div>
            </section>

            <section class="method-section">
                <h3>üîç RAG (Í≤ÄÏÉâ Ï¶ùÍ∞ï ÏÉùÏÑ±)</h3>
                <p><strong>Retrieval-Augmented Generation</strong> Î∞©ÏãùÏúºÎ°ú Ï†ïÌôïÌïú Ï∂úÏ≤òÎ•º Ï†úÍ≥µÌï©ÎãàÎã§.</p>

                <p><strong>ÏûëÎèô ÏõêÎ¶¨:</strong></p>
                <p>‚ë† ÏßàÎ¨∏ÏùÑ GeminiÎ°ú 3072Ï∞®Ïõê Î≤°ÌÑ∞Î°ú Î≥ÄÌôò<br>
                ‚ë° ChromaDBÏóêÏÑú Ïú†ÏÇ¨ÎèÑ ÏÉÅÏúÑ 10Í∞ú Í≤ΩÏ†Ñ Ï∂îÏ∂ú (ÏûêÏÑ∏Ìûà Î™®Îìú: 20Í∞ú)<br>
                ‚ë¢ Ï∂îÏ∂úÎêú Í≤ΩÏ†ÑÏùÑ Gemini 2.5 ProÏóê Ìï®Íªò Ï†úÍ≥µ</p>

                <p>Îã®Ïàú ÌÇ§ÏõåÎìú Îß§Ïπ≠Ïù¥ ÏïÑÎãå, <strong>ÏùòÎØ∏ Í∏∞Î∞ò Í≤ÄÏÉâ</strong>ÏúºÎ°ú Í¥ÄÎ†® Í≤ΩÏ†ÑÏùÑ Ï∞æÏäµÎãàÎã§.</p>
            </section>

            <section class="method-section">
                <h3>ü§ñ Gemini 2.5 Pro ÎãµÎ≥Ä ÏÉùÏÑ±</h3>
                <p><strong>Google Gemini 2.5 Pro</strong> (Vertex AI)Í∞Ä Í≤ÄÏÉâÎêú Í≤ΩÏ†ÑÏùÑ Î∂ÑÏÑùÌïòÏó¨ ÎãµÎ≥ÄÏùÑ ÏûëÏÑ±Ìï©ÎãàÎã§.</p>

                <p><strong>Ïôú Gemini 2.5 ProÏù∏Í∞Ä?</strong></p>
                <p>‚ú® <strong>2M ÌÜ†ÌÅ∞ Ïª®ÌÖçÏä§Ìä∏</strong> - ÏùºÎ∞ò Î™®Îç∏ ÎåÄÎπÑ 15Î∞∞ Ïù¥ÏÉÅ!<br>
                üìö ÏïΩ 1,500ÌéòÏù¥ÏßÄ Î∂ÑÎüâÏùÑ ÎèôÏãú Î∂ÑÏÑù Í∞ÄÎä•<br>
                üéØ Ïó¨Îü¨ Í≤ΩÏ†ÑÏùÑ Ï¢ÖÌï©ÌïòÏó¨ ÍπäÏù¥ ÏûàÎäî ÎãµÎ≥Ä ÏÉùÏÑ±</p>

                <div class="feature-badge" title="Ïª®ÌÖçÏä§Ìä∏ ÏúàÎèÑÏö∞ ÌÅ¨Í∏∞">2M ÌÜ†ÌÅ∞ = 1,500ÌéòÏù¥ÏßÄ</div>
            </section>

            <section class="method-section">
                <h3>üìä Ï†ÑÏ≤¥ ÌååÏù¥ÌîÑÎùºÏù∏</h3>
                <div class="pipeline-visual">‚ë† ÏßàÎ¨∏ ÏûÖÎ†• (ÌïúÍµ≠Ïñ¥)
   ‚Üì
‚ë° Gemini ÏûÑÎ≤†Îî©
   ‚Üí 3072Ï∞®Ïõê Î≤°ÌÑ∞ Î≥ÄÌôò
   ‚Üì
‚ë¢ ChromaDB Î≤°ÌÑ∞ Í≤ÄÏÉâ
   ‚Üí Ïú†ÏÇ¨ÎèÑ Í≥ÑÏÇ∞ (Î¨∏ÏÑúÎèÑ Gemini 3072-dim)
   ‚Üì
‚ë£ ÏÉÅÏúÑ 10Í∞ú Í≤ΩÏ†Ñ Ï∂îÏ∂ú (ÏûêÏÑ∏Ìûà: 20Í∞ú)
   ‚Üí Í¥ÄÎ†®ÎèÑ ÎÜíÏùÄ Íµ¨Ï†à ÏÑ†Î≥Ñ
   ‚Üì
‚ë§ Gemini 2.5 Pro Î∂ÑÏÑù
   ‚Üí 2M ÌÜ†ÌÅ∞ Ï¢ÖÌï© Î∂ÑÏÑù
   ‚Üì
‚ë• Î∂àÍµê ÍµêÎ¶¨ Í∏∞Î∞ò ÎãµÎ≥Ä ÏÉùÏÑ± ‚úì</div>
            </section>

            <section class="method-section" style="border: none; padding-bottom: 0;">
                <h3>üí° Í∏∞Ïà† Ïö©Ïñ¥ ÏÑ§Î™Ö</h3>
                <p><strong>ÏûÑÎ≤†Îî© (Embedding)</strong>: ÌÖçÏä§Ìä∏Î•º Ïà´Ïûê Î≤°ÌÑ∞Î°ú Î≥ÄÌôòÌïòÎäî Í∏∞Ïà†. ÏùòÎØ∏Í∞Ä ÎπÑÏä∑Ìïú Î¨∏Ïû•ÏùÄ Î≤°ÌÑ∞ Í≥µÍ∞ÑÏóêÏÑú Í∞ÄÍπåÏö¥ ÏúÑÏπòÏóê Î∞∞ÏπòÎê©ÎãàÎã§.</p>

                <p><strong>Î≤°ÌÑ∞ (Vector)</strong>: Îã§Ï∞®Ïõê Ïà´Ïûê Ï¢åÌëú. ÌòÑÏû¨ ÏãúÏä§ÌÖúÏùÄ Í≤ΩÏ†ÑÍ≥º ÏßàÎ¨∏ Î™®Îëê GeminiÎ°ú 3072Ï∞®Ïõê Í≥µÍ∞ÑÏùò Ìïú Ï†êÏúºÎ°ú ÌëúÌòÑÌï©ÎãàÎã§.</p>

                <p><strong>2Í∞ÄÏßÄ ÏûÑÎ≤†Îî© Î™®Îç∏ Ïã§Ìóò</strong>: Ï≤òÏùåÏóê BAAI/bge-m3 (1024-dim)Î°ú ÏûÑÎ≤†Îî©ÌñàÍ≥†, Ïù¥ÌõÑ Gemini (3072-dim)Î°ú Ïû¨ÏûÑÎ≤†Îî©ÌñàÏäµÎãàÎã§. ÌòÑÏû¨Îäî Gemini ÏûÑÎ≤†Îî©ÏùÑ ÏÇ¨Ïö©Ìï©ÎãàÎã§.</p>
            </section>
        </div>
    </div>

    <!-- Left Edge Close Button -->
    <div class="methodology-edge-close">
        <button onclick="toggleMethodologyPanel()" class="edge-close-btn" aria-label="Î∞©Î≤ïÎ°† Ïà®Í∏∞Í∏∞">
            <span class="close-icon">‚ñ∂</span>
        </button>
    </div>

    <!-- Methodology Toggle Button -->
    <button class="methodology-toggle" onclick="toggleMethodologyPanel()" title="Î∞©Î≤ïÎ°† Î≥¥Í∏∞ (Shift+M)">
        Î∞©Î≤ïÎ°†
    </button>

    <!-- Full-Screen Library Overlay -->
    <div id="libraryOverlay" class="library-overlay" role="dialog" aria-modal="true" aria-labelledby="libraryTitle">
        <!-- Backdrop -->
        <div class="library-backdrop" onclick="closeLibrary()"></div>

        <!-- Library Container -->
        <div class="library-container" id="libraryContainer">
            <!-- Header -->
            <div class="library-header">
                <div class="library-header-top">
                    <h2 id="libraryTitle">üìö Í≤ΩÏ†Ñ ÎùºÏù¥Î∏åÎü¨Î¶¨</h2>
                    <button class="library-close" onclick="closeLibrary()" aria-label="ÎùºÏù¥Î∏åÎü¨Î¶¨ Îã´Í∏∞">
                        ‚úï
                    </button>
                </div>

                <!-- Search Bar -->
                <div class="library-search-bar">
                    <input
                        type="text"
                        id="librarySearch"
                        placeholder="Í≤ΩÏ†Ñ Ï†úÎ™©, ÎÇ¥Ïö© Í≤ÄÏÉâ..."
                        aria-label="Í≤ΩÏ†Ñ Í≤ÄÏÉâ"
                        oninput="filterLibraryCards()"
                    />
                </div>

                <!-- Filters -->
                <div class="library-filters">
                    <select id="libraryThemeFilter" onchange="filterLibraryCards()" aria-label="Ï£ºÏ†ú ÌïÑÌÑ∞">
                        <option value="">Î™®Îì† Ï£ºÏ†ú</option>
                    </select>

                    <select id="libraryTraditionFilter" onchange="filterLibraryCards()" aria-label="Ï†ÑÌÜµ ÌïÑÌÑ∞">
                        <option value="">Î™®Îì† Ï†ÑÌÜµ</option>
                    </select>

                    <button class="filter-reset-btn" onclick="resetAllFilters()" aria-label="ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî">
                        Ï¥àÍ∏∞Ìôî
                    </button>
                </div>

                <!-- Filter Badges -->
                <div id="libraryFilterBadges" class="library-filter-badges"></div>

                <!-- Results Count -->
                <div class="library-results-count" id="libraryResultsCount">
                    Ï†ÑÏ≤¥ <span>0</span>Í∞ú Í≤ΩÏ†Ñ
                </div>
            </div>

            <!-- Loading State -->
            <div id="libraryLoading" class="library-loading" style="display: none;">
                <div class="loading-spinner"></div>
                <p>Í≤ΩÏ†ÑÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
            </div>

            <!-- Empty State -->
            <div id="libraryEmpty" class="library-empty" style="display: none;">
                <div class="empty-icon">üìö</div>
                <h3>Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</h3>
                <p>Îã§Î•∏ Í≤ÄÏÉâÏñ¥ÎÇò ÌïÑÌÑ∞Î•º ÏãúÎèÑÌï¥Î≥¥ÏÑ∏Ïöî</p>
            </div>

            <!-- Scripture Cards Grid -->
            <div class="library-grid" id="libraryGrid">
                <!-- Cards rendered by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Full-Screen Library Script -->
    <script src="/js/library.js" defer></script>
</body>
</html>
