<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î∂àÍµê AI Ï±óÎ¥á ÌÖåÏä§Ìä∏ | Buddhist AI Chatbot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            gap: 20px;
        }

        .sidebar {
            width: 350px;
            height: calc(100vh - 40px);
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed {
            transform: translateX(-370px);
        }

        .sidebar-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .sidebar-header h2 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 12px;
            opacity: 0.9;
        }

        .sidebar-search {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .sidebar-search input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            font-size: 13px;
            outline: none;
            transition: border-color 0.3s;
        }

        .sidebar-search input:focus {
            border-color: #667eea;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .source-card {
            background: #f7fafc;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid #667eea;
        }

        .source-card:hover {
            background: #edf2f7;
            transform: translateX(3px);
        }

        .source-card-title {
            font-size: 13px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .source-card-summary {
            font-size: 11px;
            color: #718096;
            line-height: 1.5;
            margin-bottom: 5px;
        }

        .source-card-meta {
            display: flex;
            gap: 5px;
            font-size: 10px;
        }

        .source-tag {
            padding: 2px 8px;
            background: white;
            border-radius: 10px;
            color: #667eea;
        }

        .sidebar-toggle {
            position: absolute;
            left: 370px;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .sidebar-toggle:hover {
            background: #667eea;
            color: white;
        }

        .sidebar.collapsed + .sidebar-toggle {
            left: 20px;
        }

        .container {
            flex: 1;
            max-width: 900px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        /* Source Detail Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .modal-header h3 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .modal-header p {
            font-size: 12px;
            opacity: 0.9;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-section {
            margin-bottom: 20px;
        }

        .modal-section h4 {
            font-size: 14px;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .modal-section p {
            font-size: 13px;
            color: #4a5568;
            line-height: 1.8;
        }

        .modal-themes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .theme-tag {
            padding: 5px 12px;
            background: #edf2f7;
            border-radius: 15px;
            font-size: 11px;
            color: #667eea;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.3);
        }

        @media (max-width: 1200px) {
            body {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                max-height: 300px;
            }

            .sidebar.collapsed {
                transform: translateY(-320px);
            }

            .sidebar-toggle {
                left: 50%;
                transform: translateX(-50%);
                top: auto;
                bottom: -20px;
            }

            .sidebar.collapsed + .sidebar-toggle {
                left: 50%;
                transform: translateX(-50%);
                top: -20px;
                bottom: auto;
            }

            .container {
                max-width: 100%;
            }
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .status {
            background: #f7fafc;
            padding: 15px 30px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #48bb78;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .chat-container {
            height: 500px;
            overflow-y: auto;
            padding: 30px;
            background: #f7fafc;
        }

        .message {
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            text-align: right;
        }

        .message-content {
            display: inline-block;
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 18px;
            line-height: 1.6;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
        }

        .message.assistant .message-content {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: left;
        }

        .sources {
            margin-top: 15px;
            padding: 15px;
            background: #edf2f7;
            border-radius: 12px;
            font-size: 12px;
        }

        .sources h4 {
            margin-bottom: 10px;
            color: #2d3748;
            font-size: 13px;
        }

        .source-item {
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #667eea;
            cursor: pointer;
            transition: all 0.2s;
        }

        .source-item:hover {
            background: #f7fafc;
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        }

        .source-item strong {
            color: #667eea;
        }

        .loading {
            display: inline-flex;
            gap: 4px;
            padding: 15px 20px;
            background: white;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            animation: bounce 1.4s ease-in-out infinite;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .input-container {
            padding: 20px 30px;
            background: white;
            border-top: 1px solid #e2e8f0;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
        }

        #queryInput {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 15px;
            outline: none;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        #queryInput:focus {
            border-color: #667eea;
        }

        #sendButton {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #sendButton:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        #sendButton:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .filter-badge-container {
            margin-bottom: 10px;
            padding: 10px 15px;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-radius: 10px;
            border-left: 3px solid #667eea;
        }

        .filter-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: white;
            border-radius: 20px;
            font-size: 14px;
            color: #667eea;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        }

        .filter-badge-close {
            background: none;
            border: none;
            color: #667eea;
            font-size: 20px;
            line-height: 1;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .filter-badge-close:hover {
            background: #667eea15;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 80px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            margin-top: 5px;
        }

        .autocomplete-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f7fafc;
            transition: background 0.2s;
        }

        .autocomplete-item:hover {
            background: #f7fafc;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 3px;
        }

        .autocomplete-id {
            font-size: 12px;
            color: #718096;
        }

        .example-queries {
            margin-top: 15px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .example-query {
            padding: 8px 15px;
            background: #edf2f7;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .example-query:hover {
            background: #667eea;
            color: white;
        }

        .latency {
            margin-top: 5px;
            font-size: 11px;
            color: #718096;
        }

        .followup-button {
            margin-top: 10px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .followup-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .followup-button.active {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .followup-indicator {
            padding: 8px 12px;
            background: linear-gradient(135deg, #48bb7820 0%, #38a16920 100%);
            border-left: 3px solid #48bb78;
            border-radius: 8px;
            font-size: 12px;
            color: #2d3748;
            margin-bottom: 10px;
            display: none;
        }

        .followup-indicator.active {
            display: block;
        }

        .conversation-depth {
            font-size: 11px;
            color: #718096;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- Source Explorer Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>üìñ Í≤ΩÏ†Ñ ÎùºÏù¥Î∏åÎü¨Î¶¨</h2>
            <p id="sourceCount">Í≤ΩÏ†Ñ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
        </div>
        <div class="sidebar-search">
            <input
                type="text"
                id="sourceSearch"
                placeholder="Í≤ΩÏ†Ñ Í≤ÄÏÉâ..."
                oninput="filterSources()"
            />
        </div>
        <div class="sidebar-content" id="sourceList">
            <!-- Source cards will be populated dynamically -->
        </div>
    </div>

    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">
        ‚óÄ
    </button>

    <!-- Main Container -->
    <div class="container">
        <div class="header">
            <h1>üôè Î∂àÍµê AI Ï±óÎ¥á</h1>
            <p>Fine-tuned BERT ÏûÑÎ≤†Îî© + Gemini 2.0 Flash | CBETA ÎåÄÏû•Í≤Ω 99,723 Î¨∏ÏÑú</p>
        </div>

        <div class="status">
            <div class="status-badge">
                <div class="status-dot"></div>
                <span>ÏÑúÎ≤Ñ Ïó∞Í≤∞Îê®</span>
            </div>
            <div style="color: #718096;">
                <span id="modelInfo">Model: Gemini 2.0 Flash Exp | Embeddings: Fine-tuned BERT 768-dim</span>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="message assistant">
                <div class="message-content">
                    ÏïàÎÖïÌïòÏÑ∏Ïöî! Ï†ÄÎäî CBETA ÎåÄÏû•Í≤ΩÏùÑ Í∏∞Î∞òÏúºÎ°ú Ìïú Î∂àÍµê AI Ï±óÎ¥áÏûÖÎãàÎã§.<br><br>
                    Í∂ÅÍ∏àÌïòÏã† Î∂àÍµê ÍµêÎ¶¨ÎÇò Í≤ΩÏ†Ñ ÎÇ¥Ïö©ÏùÑ ÏßàÎ¨∏Ìï¥ Ï£ºÏÑ∏Ïöî. Ï†ïÌôïÌïú Ï∂úÏ≤òÏôÄ Ìï®Íªò ÎãµÎ≥ÄÎìúÎ¶¨Í≤†ÏäµÎãàÎã§.
                </div>
            </div>
        </div>

        <div class="input-container">
            <!-- Follow-up indicator -->
            <div id="followupIndicator" class="followup-indicator">
                <span>‚Ü©Ô∏è ÌõÑÏÜç ÏßàÎ¨∏ Î™®Îìú ÌôúÏÑ±Ìôî</span>
                <button class="filter-badge-close" onclick="deactivateFollowup()">√ó</button>
            </div>

            <!-- Separate badges for detailed mode and sutra filter -->
            <div id="detailedModeBadge" class="filter-badge-container" style="display: none;">
                <div class="filter-badge">
                    <span>üîç ÏûêÏÑ∏Ìûà Î™®Îìú</span>
                    <button class="filter-badge-close" onclick="clearDetailedMode()">√ó</button>
                </div>
            </div>
            <div id="sutraFilterBadge" class="filter-badge-container" style="display: none;">
                <div class="filter-badge">
                    <span id="sutraFilterText"></span>
                    <button class="filter-badge-close" onclick="clearSutraFilter()">√ó</button>
                </div>
            </div>
            <div class="input-wrapper" style="position: relative;">
                <input
                    type="text"
                    id="queryInput"
                    placeholder="Î∂àÍµê ÍµêÎ¶¨Ïóê ÎåÄÌï¥ ÏßàÎ¨∏Ìï¥ Ï£ºÏÑ∏Ïöî... (Ïòà: ÏÇ¨ÏÑ±Ï†úÎûÄ Î¨¥ÏóáÏù∏Í∞ÄÏöî? ÎòêÎäî /Ïû•ÏïÑÌï®Í≤Ω)"
                    onkeypress="if(event.key === 'Enter' && !autocompleteVisible) sendQuery()"
                    oninput="handleSlashCommand()"
                />
                <button id="sendButton" onclick="sendQuery()">Ï†ÑÏÜ°</button>
                <div id="autocompleteDropdown" class="autocomplete-dropdown" style="display: none;"></div>
            </div>
            <div class="example-queries">
                <div class="example-query" onclick="setQuery('ÏÇ¨ÏÑ±Ï†úÎûÄ Î¨¥ÏóáÏù∏Í∞ÄÏöî?')">ÏÇ¨ÏÑ±Ï†úÎûÄ?</div>
                <div class="example-query" onclick="setQuery('ÌåîÏ†ïÎèÑÏóê ÎåÄÌï¥ ÏÑ§Î™ÖÌï¥Ï£ºÏÑ∏Ïöî')">ÌåîÏ†ïÎèÑ</div>
                <div class="example-query" onclick="setQuery('Î¨¥ÏÉÅ(ÁÑ°Â∏∏)Ïùò ÏùòÎØ∏Îäî?')">Î¨¥ÏÉÅ(ÁÑ°Â∏∏)</div>
                <div class="example-query" onclick="setQuery('Ïó∞Í∏∞Î≤ïÏù¥ÎûÄ Î¨¥ÏóáÏù∏Í∞ÄÏöî?')">Ïó∞Í∏∞Î≤ï</div>
                <div class="example-query" onclick="setQuery('ÏûêÎπÑÏôÄ ÏßÄÌòúÏùò Í¥ÄÍ≥Ñ')">ÏûêÎπÑÏôÄ ÏßÄÌòú</div>
            </div>
        </div>
    </div>

    <!-- Source Detail Modal -->
    <div class="modal" id="sourceModal" onclick="if(event.target === this) closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <button class="modal-close" onclick="closeModal()">√ó</button>
                <h3 id="modalTitle">Í≤ΩÏ†Ñ Ï†úÎ™©</h3>
                <p id="modalMeta">Ï†ÄÏûê | ÏãúÎåÄ | Ï†ÑÌÜµ</p>
            </div>
            <div class="modal-body">
                <div class="modal-section">
                    <h4>üìú Í∞ÑÎûµ ÏöîÏïΩ</h4>
                    <p id="modalBriefSummary"></p>
                </div>
                <div class="modal-section">
                    <h4>üìñ ÏÉÅÏÑ∏ ÏöîÏïΩ</h4>
                    <p id="modalDetailedSummary"></p>
                </div>
                <div class="modal-section">
                    <h4>üîë ÌïµÏã¨ Ï£ºÏ†ú</h4>
                    <div class="modal-themes" id="modalThemes"></div>
                </div>
                <div class="modal-section">
                    <h4>üìö ÏõêÎ¨∏ Ï†ïÎ≥¥</h4>
                    <p id="modalOriginalInfo"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== Source Explorer =====
        let allSources = [];
        let filteredSources = [];
        let activeFilters = {
            tradition: null,
            period: null
        };

        // Load sources on page load
        async function loadSources() {
            try {
                const response = await fetch('http://localhost:8000/api/sources?limit=2500');
                if (!response.ok) throw new Error('Failed to load sources');

                const data = await response.json();
                allSources = data.sources;
                filteredSources = [...allSources];

                document.getElementById('sourceCount').textContent =
                    `Ï¥ù ${data.total.toLocaleString()}Í∞ú Í≤ΩÏ†Ñ (${data.sources.length}Í∞ú ÌëúÏãú)`;

                renderSources();
            } catch (error) {
                console.error('Error loading sources:', error);
                document.getElementById('sourceCount').textContent = 'Í≤ΩÏ†Ñ Î°úÎî© Ïã§Ìå®';
            }
        }

        // Render source cards
        function renderSources() {
            const sourceList = document.getElementById('sourceList');

            if (filteredSources.length === 0) {
                sourceList.innerHTML = '<div style="padding:20px;text-align:center;color:#718096;">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</div>';
                return;
            }

            sourceList.innerHTML = filteredSources.map(source => `
                <div class="source-card" onclick="showSourceDetail('${source.sutra_id}')">
                    <div class="source-card-title">${source.title_ko || source.original_title}</div>
                    <div class="source-card-summary">${source.brief_summary || 'ÏöîÏïΩ Ï†ïÎ≥¥ ÏóÜÏùå'}</div>
                    <div class="source-card-meta">
                        ${source.tradition ? `<span class="source-tag">${source.tradition}</span>` : ''}
                        ${source.period ? `<span class="source-tag">${source.period}</span>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Filter sources by search term
        function filterSources() {
            const searchTerm = document.getElementById('sourceSearch').value.toLowerCase();

            filteredSources = allSources.filter(source => {
                return !searchTerm ||
                    source.title_ko?.toLowerCase().includes(searchTerm) ||
                    source.original_title?.toLowerCase().includes(searchTerm) ||
                    source.brief_summary?.toLowerCase().includes(searchTerm);
            });

            renderSources();
        }

        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggle = document.getElementById('sidebarToggle');

            sidebar.classList.toggle('collapsed');
            toggle.textContent = sidebar.classList.contains('collapsed') ? '‚ñ∂' : '‚óÄ';
        }

        // Show source detail modal
        async function showSourceDetail(sutraId) {
            try {
                const response = await fetch(`http://localhost:8000/api/sources/${sutraId}`);
                if (!response.ok) throw new Error('Failed to load source detail');

                const source = await response.json();

                // Populate modal
                document.getElementById('modalTitle').textContent = source.title_ko || source.original_title;
                document.getElementById('modalMeta').textContent =
                    `${source.author || 'ÏûëÏûê ÎØ∏ÏÉÅ'} | ${source.period || 'ÏãúÎåÄ ÎØ∏ÏÉÅ'} | ${source.tradition || 'Ï†ÑÌÜµ ÎØ∏ÏÉÅ'}`;
                document.getElementById('modalBriefSummary').textContent = source.brief_summary || 'ÏöîÏïΩ Ï†ïÎ≥¥ ÏóÜÏùå';
                document.getElementById('modalDetailedSummary').textContent = source.detailed_summary || 'ÏÉÅÏÑ∏ ÏöîÏïΩ Ï†ïÎ≥¥ ÏóÜÏùå';

                // Themes
                const themesContainer = document.getElementById('modalThemes');
                if (source.key_themes && source.key_themes.length > 0) {
                    themesContainer.innerHTML = source.key_themes.map(theme =>
                        `<span class="theme-tag">${theme}</span>`
                    ).join('');
                } else {
                    themesContainer.innerHTML = '<span style="color:#718096;font-size:12px;">Ï£ºÏ†ú Ï†ïÎ≥¥ ÏóÜÏùå</span>';
                }

                // Original info
                document.getElementById('modalOriginalInfo').innerHTML = `
                    <strong>ÏõêÏ†úÎ™©:</strong> ${source.original_title}<br>
                    <strong>Ï†ÄÏûê:</strong> ${source.author || 'ÎØ∏ÏÉÅ'}<br>
                    <strong>ÎåÄÏû•Í≤Ω Î≤àÌò∏:</strong> ${sutraId}<br>
                    <strong>Í∂åÏàò:</strong> Ï†ú${source.volume}Í∂å Ï†ú${source.juan}
                `;

                // Show modal
                document.getElementById('sourceModal').classList.add('active');
            } catch (error) {
                console.error('Error loading source detail:', error);
                alert('Í≤ΩÏ†Ñ ÏÉÅÏÑ∏ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('sourceModal').classList.remove('active');
        }

        // ===== Chat Functionality =====
        const API_URL = 'http://localhost:8000/api/chat';
        const chatContainer = document.getElementById('chatContainer');
        const queryInput = document.getElementById('queryInput');
        const sendButton = document.getElementById('sendButton');

        // Slash command state
        let currentSutraFilter = null;
        let detailedModeActive = false;
        let autocompleteVisible = false;

        // Follow-up state
        let activeSessionId = null;
        let activeConversationDepth = 0;

        function setQuery(text) {
            queryInput.value = text;
            queryInput.focus();
        }

        // Handle slash command input
        function handleSlashCommand() {
            const value = queryInput.value;
            const dropdown = document.getElementById('autocompleteDropdown');

            // Check if input starts with /
            if (value.startsWith('/')) {
                const searchTerm = value.substring(1).toLowerCase();

                // Special commands (ÏûêÏÑ∏Ìûà detailed mode)
                const specialCommands = [
                    { command: 'ÏûêÏÑ∏Ìûà', description: 'ÏÉÅÏÑ∏ÌïòÍ≥† Ìè¨Í¥ÑÏ†ÅÏù∏ ÎãµÎ≥Ä', color: '#9b59b6' }
                ];

                // Filter special commands
                const matchingCommands = specialCommands.filter(cmd =>
                    cmd.command.toLowerCase().includes(searchTerm)
                );

                // Filter sources matching the search term
                const matchingSources = allSources.filter(source => {
                    return source.title_ko.toLowerCase().includes(searchTerm) ||
                           source.original_title.toLowerCase().includes(searchTerm) ||
                           source.sutra_id.toLowerCase().includes(searchTerm);
                }).slice(0, 8); // Limit to 8 results

                const matches = [...matchingCommands.map(cmd => ({ type: 'command', data: cmd })),
                                 ...matchingSources.map(src => ({ type: 'source', data: src }))];

                if (matches.length > 0) {
                    // Show dropdown with matches
                    dropdown.innerHTML = matches.map(match => {
                        if (match.type === 'command') {
                            return `
                                <div class="autocomplete-item" onclick="selectDetailedMode()" style="border-left: 3px solid ${match.data.color};">
                                    <div class="autocomplete-title" style="color: ${match.data.color};">/${match.data.command}</div>
                                    <div class="autocomplete-id">${match.data.description}</div>
                                </div>
                            `;
                        } else {
                            return `
                                <div class="autocomplete-item" onclick="selectSutra('${match.data.sutra_id}', '${match.data.title_ko.replace(/'/g, "\\'")}')">
                                    <div class="autocomplete-title">${match.data.title_ko}</div>
                                    <div class="autocomplete-id">${match.data.sutra_id} ‚Ä¢ ${match.data.volume}</div>
                                </div>
                            `;
                        }
                    }).join('');
                    dropdown.style.display = 'block';
                    autocompleteVisible = true;
                } else {
                    dropdown.style.display = 'none';
                    autocompleteVisible = false;
                }
            } else {
                // Hide dropdown if not a slash command
                dropdown.style.display = 'none';
                autocompleteVisible = false;
            }
        }

        // Select detailed mode
        function selectDetailedMode() {
            detailedModeActive = true;

            // Clear input and hide dropdown
            queryInput.value = '';
            document.getElementById('autocompleteDropdown').style.display = 'none';
            autocompleteVisible = false;

            // Show detailed mode badge
            const detailedBadge = document.getElementById('detailedModeBadge');
            detailedBadge.style.display = 'block';
            detailedBadge.style.background = 'linear-gradient(135deg, #9b59b615 0%, #9b59b615 100%)';
            detailedBadge.style.borderLeft = '3px solid #9b59b6';

            // Update input styling based on active modes
            updateInputStyling();

            // Focus input
            queryInput.focus();
        }

        // Clear detailed mode
        function clearDetailedMode() {
            detailedModeActive = false;
            document.getElementById('detailedModeBadge').style.display = 'none';
            updateInputStyling();
        }

        // Select a sutra from autocomplete
        function selectSutra(sutraId, sutraTitle) {
            currentSutraFilter = sutraId;

            // Clear input and hide dropdown
            queryInput.value = '';
            document.getElementById('autocompleteDropdown').style.display = 'none';
            autocompleteVisible = false;

            // Show sutra filter badge
            const sutraBadge = document.getElementById('sutraFilterBadge');
            const sutraText = document.getElementById('sutraFilterText');
            sutraText.textContent = `ÌïÑÌÑ∞: ${sutraTitle}`;
            sutraBadge.style.display = 'block';
            sutraBadge.style.background = 'linear-gradient(135deg, #667eea15 0%, #764ba215 100%)';
            sutraBadge.style.borderLeft = '3px solid #667eea';

            // Update input styling based on active modes
            updateInputStyling();

            // Focus input
            queryInput.focus();
        }

        // Clear sutra filter
        function clearSutraFilter() {
            currentSutraFilter = null;
            document.getElementById('sutraFilterBadge').style.display = 'none';
            updateInputStyling();
        }

        // Update input border styling based on active modes
        function updateInputStyling() {
            if (detailedModeActive && currentSutraFilter) {
                // Both modes active - use a gradient border
                queryInput.style.borderColor = '#667eea';
                queryInput.style.boxShadow = '0 0 0 3px rgba(155, 89, 182, 0.1)';
            } else if (detailedModeActive) {
                // Only detailed mode
                queryInput.style.borderColor = '#9b59b6';
                queryInput.style.boxShadow = '0 0 0 3px rgba(155, 89, 182, 0.1)';
            } else if (currentSutraFilter) {
                // Only sutra filter
                queryInput.style.borderColor = '#667eea';
                queryInput.style.boxShadow = '0 0 0 3px rgba(102, 126, 234, 0.1)';
            } else {
                // No modes active
                queryInput.style.borderColor = '';
                queryInput.style.boxShadow = '';
            }
        }

        async function sendQuery() {
            let query = queryInput.value.trim();
            if (!query) return;

            // Detect /ÏûêÏÑ∏Ìûà prefix for detailed mode OR check if detailed mode is active
            let detailedMode = detailedModeActive;
            if (query.startsWith('/ÏûêÏÑ∏Ìûà ')) {
                detailedMode = true;
                query = query.substring(5).trim(); // Remove "/ÏûêÏÑ∏Ìûà " prefix
            }

            // Add user message (show original query with prefix if used)
            addMessage(queryInput.value.trim(), 'user');
            queryInput.value = '';
            sendButton.disabled = true;

            // Note: Do NOT clear detailed mode after sending
            // It should persist until user manually closes the badge

            // Show loading
            const loadingId = showLoading();

            try {
                // Build request body with optional sutra filter, detailed mode, and follow-up
                const requestBody = { query };
                if (currentSutraFilter) {
                    requestBody.sutra_filter = currentSutraFilter;
                }
                if (detailedMode) {
                    requestBody.detailed_mode = true;
                }
                if (activeSessionId) {
                    requestBody.session_id = activeSessionId;
                    requestBody.is_followup = true;
                }

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // Remove loading
                removeLoading(loadingId);

                // Add assistant response with session info and cache status
                addMessage(data.response, 'assistant', data.sources, data.latency_ms, data.session_id, data.conversation_depth, data.from_cache);

            } catch (error) {
                removeLoading(loadingId);
                addMessage(`Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${error.message}`, 'assistant');
            } finally {
                sendButton.disabled = false;
                queryInput.focus();
            }
        }

        function parseMarkdown(text) {
            // Split into paragraphs
            let html = text.split('\n\n').map(paragraph => {
                // Check if it's a numbered list
                if (/^\d+\.\s/.test(paragraph)) {
                    const items = paragraph.split('\n').filter(line => /^\d+\.\s/.test(line));
                    const listItems = items.map(item => {
                        const content = item.replace(/^\d+\.\s+/, '');
                        return `<li>${formatInlineMarkdown(content)}</li>`;
                    }).join('');
                    return `<ol>${listItems}</ol>`;
                }

                // Check if it's a bullet list
                if (/^[-*‚Ä¢]\s/.test(paragraph)) {
                    const items = paragraph.split('\n').filter(line => /^[-*‚Ä¢]\s/.test(line));
                    const listItems = items.map(item => {
                        const content = item.replace(/^[-*‚Ä¢]\s+/, '');
                        return `<li>${formatInlineMarkdown(content)}</li>`;
                    }).join('');
                    return `<ul>${listItems}</ul>`;
                }

                // Check if it's a heading
                if (paragraph.startsWith('### ')) {
                    return `<h4>${formatInlineMarkdown(paragraph.substring(4))}</h4>`;
                }
                if (paragraph.startsWith('## ')) {
                    return `<h3>${formatInlineMarkdown(paragraph.substring(3))}</h3>`;
                }

                // Regular paragraph
                return `<p>${formatInlineMarkdown(paragraph)}</p>`;
            }).join('');

            return html;
        }

        function formatInlineMarkdown(text) {
            // Bold: **text** or __text__
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/__(.+?)__/g, '<strong>$1</strong>');

            // Code or inline formatting with backticks
            text = text.replace(/`(.+?)`/g, '<code style="background:#f1f5f9;padding:2px 6px;border-radius:3px;font-size:0.9em;">$1</code>');

            // Single line breaks
            text = text.replace(/\n/g, '<br>');

            return text;
        }

        function addMessage(content, role, sources = null, latency = null, sessionId = null, conversationDepth = null, fromCache = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            // Add cache badge if this is a cached response
            if (role === 'assistant' && fromCache) {
                const cacheBadge = document.createElement('div');
                cacheBadge.style.cssText = 'display: inline-block; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-bottom: 12px;';
                cacheBadge.innerHTML = 'üíæ Ï∫êÏãúÎêú ÎãµÎ≥Ä (Ï†ÄÏû•Îêú Í≥†ÌíàÏßà ÎãµÎ≥Ä)';
                contentDiv.appendChild(cacheBadge);
            }

            // Parse markdown for assistant messages
            if (role === 'assistant') {
                const textDiv = document.createElement('div');
                textDiv.innerHTML = parseMarkdown(content);
                contentDiv.appendChild(textDiv);
            } else {
                contentDiv.textContent = content;
            }

            if (sources && sources.length > 0) {
                const sourcesDiv = document.createElement('div');
                sourcesDiv.className = 'sources';
                sourcesDiv.innerHTML = '<h4>üìö Ï∂úÏ≤ò (Sources):</h4>';

                sources.forEach((source, idx) => {
                    const sourceItem = document.createElement('div');
                    sourceItem.className = 'source-item';
                    sourceItem.style.cursor = 'pointer';
                    sourceItem.innerHTML = `<strong>${idx + 1}. ${source.title}</strong> (${source.text_id})<br>${source.excerpt.substring(0, 100)}...`;
                    sourceItem.onclick = () => showSourceDetail(source.text_id);
                    sourcesDiv.appendChild(sourceItem);
                });

                if (latency) {
                    const latencyDiv = document.createElement('div');
                    latencyDiv.className = 'latency';
                    latencyDiv.textContent = `‚ö° ÏùëÎãµ ÏãúÍ∞Ñ: ${latency}ms`;
                    sourcesDiv.appendChild(latencyDiv);
                }

                contentDiv.appendChild(sourcesDiv);
            }

            // Add follow-up button for assistant messages
            if (role === 'assistant' && sessionId) {
                const followupBtn = document.createElement('button');
                followupBtn.className = 'followup-button';
                followupBtn.innerHTML = '‚Ü©Ô∏è Ïù¥ ÎãµÎ≥ÄÏóê ÎåÄÌï¥ Îçî ÏßàÎ¨∏ÌïòÍ∏∞';
                followupBtn.onclick = () => activateFollowup(sessionId, conversationDepth);

                // Show conversation depth
                if (conversationDepth) {
                    const depthDiv = document.createElement('div');
                    depthDiv.className = 'conversation-depth';
                    depthDiv.textContent = `ÎåÄÌôî ÍπäÏù¥: ${conversationDepth}`;
                    contentDiv.appendChild(depthDiv);
                }

                contentDiv.appendChild(followupBtn);
            }

            messageDiv.appendChild(contentDiv);
            chatContainer.appendChild(messageDiv);

            // Scroll to show the top of the message (not the bottom)
            messageDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function showLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message assistant';
            loadingDiv.id = 'loading-' + Date.now();

            loadingDiv.innerHTML = `
                <div class="loading">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            `;

            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return loadingDiv.id;
        }

        function removeLoading(id) {
            const loadingDiv = document.getElementById(id);
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        // Follow-up functions
        function activateFollowup(sessionId, depth) {
            // Deactivate any previous follow-up buttons
            document.querySelectorAll('.followup-button.active').forEach(btn => {
                btn.classList.remove('active');
                btn.innerHTML = '‚Ü©Ô∏è Ïù¥ ÎãµÎ≥ÄÏóê ÎåÄÌï¥ Îçî ÏßàÎ¨∏ÌïòÍ∏∞';
            });

            // Activate the clicked button
            event.target.classList.add('active');
            event.target.innerHTML = '‚úì ÌõÑÏÜç ÏßàÎ¨∏ Î™®Îìú ÌôúÏÑ±ÌôîÎê®';

            // Set active session
            activeSessionId = sessionId;
            activeConversationDepth = depth;

            // Show indicator
            const indicator = document.getElementById('followupIndicator');
            indicator.classList.add('active');
            indicator.querySelector('span').textContent = `‚Ü©Ô∏è ÌõÑÏÜç ÏßàÎ¨∏ Î™®Îìú (ÎåÄÌôî ÍπäÏù¥: ${depth})`;

            // Focus input
            queryInput.focus();
        }

        function deactivateFollowup() {
            // Clear active session
            activeSessionId = null;
            activeConversationDepth = 0;

            // Hide indicator
            document.getElementById('followupIndicator').classList.remove('active');

            // Deactivate all buttons
            document.querySelectorAll('.followup-button.active').forEach(btn => {
                btn.classList.remove('active');
                btn.innerHTML = '‚Ü©Ô∏è Ïù¥ ÎãµÎ≥ÄÏóê ÎåÄÌï¥ Îçî ÏßàÎ¨∏ÌïòÍ∏∞';
            });
        }

        // ===== Initialize on Page Load =====
        window.addEventListener('DOMContentLoaded', () => {
            loadSources();
        });
    </script>
</body>
</html>
