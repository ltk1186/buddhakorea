<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>불교 AI | CBETA 대장경 탐색기</title>

    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-PRT00DHTMG"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-PRT00DHTMG');
    </script>
    <meta name="description" content="2,459개 CBETA 대장경을 AI와 함께 탐험하세요. Gemini 2.5 Pro 기반 RAG 시스템.">

    <!-- Favicon -->
    <link rel="icon" href="https://buddhakorea.com/assets/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="https://buddhakorea.com/assets/favicon.ico">

    <!-- Preload Fonts -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css" rel="stylesheet">

    <!-- Library CSS -->
    <link rel="stylesheet" href="css/library.css">

    <style>
        /* ===== CSS Variables ===== */
        :root {
            /* Colors - Sage Green (matching main site) */
            --primary: #5A9A6E;
            --primary-light: #8CB89C;
            --secondary: #A3C9AE;
            --accent: #B8D4C2;
            --gold: #5A9A6E;

            /* Backgrounds - Light Theme */
            --bg-dark: #FFFFFF;
            --bg-medium: #F8FAF8;
            --bg-light: #E8F0EB;
            --bg-card: rgba(255, 255, 255, 0.95);

            /* Glass - Light Theme */
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(90, 154, 110, 0.15);
            --glass-blur: blur(20px);

            /* Text - Dark on Light */
            --text-primary: #1d1d1f;
            --text-secondary: #6e6e73;
            --text-muted: #86868b;

            /* Typography */
            --font-main: 'Pretendard Variable', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;

            /* Spacing */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            --space-2xl: 48px;
            --space-3xl: 64px;

            /* Transitions */
            --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
            --transition-fast: 0.2s var(--ease-out);
            --transition-normal: 0.3s var(--ease-out);
            --transition-slow: 0.5s var(--ease-out);

            /* Layout */
            --max-width: 800px;
            --header-height: 60px;
            --tab-bar-height: 80px;
        }

        /* ===== Reset ===== */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-main);
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* ===== Ambient Background ===== */
        .ambient-bg {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .ambient-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.15;
            animation: float 30s ease-in-out infinite;
        }

        .ambient-orb-1 {
            width: 600px;
            height: 600px;
            background: var(--primary);
            top: -300px;
            right: -200px;
        }

        .ambient-orb-2 {
            width: 500px;
            height: 500px;
            background: var(--secondary);
            bottom: -250px;
            left: -150px;
            animation-delay: -10s;
        }

        .ambient-orb-3 {
            width: 400px;
            height: 400px;
            background: var(--accent);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation-delay: -20s;
            opacity: 0.08;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(50px, -30px) scale(1.05); }
            50% { transform: translate(-30px, 50px) scale(0.95); }
            75% { transform: translate(-50px, -20px) scale(1.02); }
        }

        /* ===== App Container ===== */
        .app {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
        }

        /* ===== Hero Section ===== */
        .hero {
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: var(--space-xl);
            position: relative;
        }

        .hero-content {
            max-width: 600px;
            animation: fadeUp 0.8s var(--ease-out);
        }

        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hero-icon {
            font-size: 4rem;
            margin-bottom: var(--space-lg);
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }

        .hero-title {
            font-size: clamp(2rem, 6vw, 3rem);
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--space-md);
            letter-spacing: -0.02em;
        }

        .hero-subtitle {
            font-size: clamp(1rem, 3vw, 1.25rem);
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: var(--space-2xl);
        }

        .hero-stats {
            display: flex;
            justify-content: center;
            gap: var(--space-xl);
            margin-bottom: var(--space-2xl);
            flex-wrap: wrap;
        }

        .hero-stat {
            text-align: center;
        }

        .hero-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gold);
        }

        .hero-stat-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-top: var(--space-xs);
        }

        /* ===== CTA Buttons ===== */
        .hero-cta {
            display: flex;
            gap: var(--space-md);
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: var(--space-2xl);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-md) var(--space-xl);
            border-radius: 100px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-fast);
            border: none;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 4px 20px rgba(90, 154, 110, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(90, 154, 110, 0.5);
        }

        .btn-secondary {
            background: var(--glass-bg);
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
            backdrop-filter: var(--glass-blur);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--primary);
        }

        /* ===== Sample Questions ===== */
        .sample-questions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
            justify-content: center;
            max-width: 500px;
        }

        .sample-question {
            padding: var(--space-sm) var(--space-md);
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 100px;
            font-size: 0.875rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .sample-question:hover {
            background: rgba(90, 154, 110, 0.15);
            border-color: var(--primary);
            color: var(--text-primary);
        }

        /* ===== Scroll Indicator ===== */
        .scroll-indicator {
            position: absolute;
            bottom: var(--space-xl);
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-sm);
            color: var(--text-muted);
            font-size: 0.75rem;
            animation: bounce 2s ease-in-out infinite;
            cursor: pointer;
            padding: var(--space-md);
            border-radius: 12px;
            transition: var(--transition-fast);
        }

        .scroll-indicator:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .scroll-indicator:hover svg {
            stroke: var(--primary);
        }

        @keyframes bounce {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(8px); }
        }

        .scroll-indicator svg {
            width: 24px;
            height: 24px;
            stroke: var(--text-muted);
            transition: var(--transition-fast);
        }

        /* ===== Chat Section ===== */
        .chat-section {
            flex: 1;
            display: none;
            flex-direction: column;
            padding-bottom: var(--tab-bar-height);
        }

        .chat-section.active {
            display: flex;
        }

        .chat-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: var(--glass-blur);
            border-bottom: 1px solid var(--glass-border);
            padding: var(--space-md) var(--space-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-header-title {
            font-size: 1.125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .chat-header-title span:first-child {
            line-height: 1;
        }

        .chat-header-actions {
            display: flex;
            gap: var(--space-sm);
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
        }

        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
        }

        /* ===== Chat Container ===== */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-lg);
            padding-bottom: 160px; /* Space for fixed input container + chips */
            max-width: var(--max-width);
            margin: 0 auto;
            width: 100%;
        }

        .chat-messages {
            display: flex;
            flex-direction: column;
            gap: var(--space-lg);
        }

        /* ===== Message Bubbles ===== */
        .message {
            display: flex;
            gap: var(--space-md);
            animation: messageIn 0.3s var(--ease-out);
        }

        @keyframes messageIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
            line-height: 1;
            text-align: center;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .message.assistant .message-avatar {
            background: var(--bg-light);
            border: 1px solid var(--glass-border);
        }

        .message-content {
            flex: 1;
            min-width: 0;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-xs);
        }

        .message-sender {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .message-text {
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            border-top-left-radius: 4px;
            padding: var(--space-md);
            line-height: 1.7;
            color: var(--text-primary);
        }

        .message.user .message-text {
            background: rgba(90, 154, 110, 0.15);
            border-color: rgba(90, 154, 110, 0.3);
            border-top-left-radius: 16px;
            border-top-right-radius: 4px;
        }

        /* ===== Sources in Message ===== */
        .message-sources {
            margin-top: var(--space-md);
            padding-top: var(--space-md);
            border-top: 1px solid var(--glass-border);
        }

        .message-sources-title {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: var(--space-sm);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .message-source-tags {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-xs);
        }

        .source-tag {
            padding: var(--space-xs) var(--space-sm);
            background: rgba(218, 165, 32, 0.1);
            border: 1px solid rgba(218, 165, 32, 0.3);
            border-radius: 100px;
            font-size: 0.75rem;
            color: var(--gold);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .source-tag:hover {
            background: rgba(218, 165, 32, 0.2);
        }

        /* ===== Chat Options (Chips) ===== */
        .chat-options {
            display: flex;
            gap: var(--space-sm);
            flex-wrap: wrap;
            margin-bottom: var(--space-md);
        }

        .chat-option-group {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .chat-option-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-right: var(--space-xs);
        }

        .chat-chip {
            padding: 6px 12px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 100px;
            font-size: 0.8125rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition-fast);
            font-family: inherit;
            white-space: nowrap;
        }

        .chat-chip:hover {
            background: rgba(90, 154, 110, 0.1);
            border-color: var(--primary);
            color: var(--text-primary);
        }

        .chat-chip.active {
            background: rgba(90, 154, 110, 0.2);
            border-color: var(--primary);
            color: var(--primary);
        }

        .chat-chip-icon {
            margin-right: 4px;
        }

        /* Divider between option groups */
        .chat-option-divider {
            width: 1px;
            height: 20px;
            background: var(--glass-border);
            margin: 0 var(--space-sm);
        }

        /* Selected sutra chip */
        .sutra-select-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 100px;
            font-size: 0.8125rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition-fast);
            max-width: 200px;
        }

        .sutra-select-chip:hover {
            background: rgba(90, 154, 110, 0.1);
            border-color: var(--primary);
        }

        .sutra-select-chip.has-selection {
            background: rgba(218, 165, 32, 0.15);
            border-color: var(--gold);
            color: var(--gold);
        }

        .sutra-select-name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
        }

        .sutra-select-clear {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            line-height: 1;
            padding: 0;
        }

        .sutra-select-clear:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* ===== Chat Input ===== */
        .chat-input-container {
            position: fixed;
            bottom: var(--tab-bar-height);
            left: 0;
            right: 0;
            padding: var(--space-md) var(--space-lg);
            background: linear-gradient(to top, var(--bg-dark) 80%, transparent);
            z-index: 90;
        }

        .chat-input-wrapper {
            max-width: var(--max-width);
            margin: 0 auto;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .chat-input-row {
            position: relative;
            display: flex;
            align-items: center;
        }

        .chat-input {
            width: 100%;
            padding: var(--space-md) var(--space-xl);
            padding-right: 60px;
            background: var(--bg-card);
            border: 2px solid var(--glass-border);
            border-radius: 24px;
            font-size: 1rem;
            color: var(--text-primary);
            outline: none;
            transition: var(--transition-fast);
            font-family: inherit;
            resize: none;
        }

        .chat-input::placeholder {
            color: var(--text-muted);
        }

        .chat-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(90, 154, 110, 0.15);
        }

        .chat-send-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
            flex-shrink: 0;
        }

        .chat-send-btn:hover {
            transform: translateY(-50%) scale(1.05);
        }

        .chat-input-row .chat-send-btn {
            position: absolute;
            right: 8px;
        }

        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chat-send-btn svg {
            width: 20px;
            height: 20px;
        }

        /* ===== Chat Welcome ===== */
        .chat-welcome {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: var(--space-2xl) var(--space-lg);
            min-height: 50vh;
            animation: fadeUp 0.5s var(--ease-out);
        }

        .chat-welcome-icon {
            font-size: 3rem;
            margin-bottom: var(--space-lg);
            opacity: 0.8;
        }

        .chat-welcome-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: var(--space-md);
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .chat-welcome-desc {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: var(--space-xl);
        }

        .chat-welcome-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
            justify-content: center;
            max-width: 400px;
        }

        .welcome-suggestion {
            padding: var(--space-sm) var(--space-md);
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 100px;
            font-size: 0.875rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition-fast);
            font-family: inherit;
        }

        .welcome-suggestion:hover {
            background: rgba(90, 154, 110, 0.15);
            border-color: var(--primary);
            color: var(--text-primary);
        }

        /* ===== Progress Indicator (Apple Watch Style) ===== */
        .progress-indicator {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            padding: 24px 32px;
            animation: fadeIn 0.3s ease;
        }

        .progress-indicator.active {
            display: flex;
        }

        .progress-ring-container {
            position: relative;
            width: 56px;
            height: 56px;
        }

        .progress-ring {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: conic-gradient(
                var(--primary) calc(var(--progress, 0) * 1%),
                rgba(255, 255, 255, 0.1) calc(var(--progress, 0) * 1%)
            );
            display: flex;
            align-items: center;
            justify-content: center;
            animation: ringPulse 2s ease-in-out infinite;
            transition: --progress 0.5s ease;
        }

        .progress-ring-inner {
            width: 46px;
            height: 46px;
            border-radius: 50%;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .progress-dharma {
            font-size: 28px;
            animation: dharmaRotate 3s linear infinite;
            opacity: 0.95;
            display: inline-block;
            transform-origin: center center;
            line-height: 1;
        }

        @keyframes dharmaRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes ringPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(90, 154, 110, 0.4);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(90, 154, 110, 0);
            }
        }

        .progress-text {
            font-size: 13px;
            color: var(--text-secondary);
            text-align: center;
            transition: opacity 0.3s ease;
        }

        /* Register custom property for conic-gradient animation */
        @property --progress {
            syntax: '<number>';
            initial-value: 0;
            inherits: false;
        }

        /* ===== Streaming Message Styles ===== */
        .message-text.streaming {
            position: relative;
        }

        .message-text.streaming::after {
            content: '▌';
            animation: cursorBlink 0.8s infinite;
            color: var(--primary);
            margin-left: 2px;
        }

        @keyframes cursorBlink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Typing animation for each character */
        .typed-char {
            display: inline;
            animation: typeIn 0.03s ease forwards;
        }

        @keyframes typeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== Tab Bar (Mobile) ===== */
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--tab-bar-height);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: var(--glass-blur);
            border-top: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 1000;
        }

        .tab-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-sm) var(--space-md);
            color: var(--text-muted);
            cursor: pointer;
            transition: var(--transition-fast);
            -webkit-tap-highlight-color: transparent;
        }

        .tab-item.active {
            color: var(--primary);
        }

        .tab-item:hover {
            color: var(--text-primary);
        }

        .tab-icon {
            width: 24px;
            height: 24px;
        }

        .tab-label {
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* ===== Library Section ===== */
        .library-section {
            display: none;
            flex-direction: column;
            min-height: 100vh;
            padding-bottom: var(--tab-bar-height);
        }

        .library-section.active {
            display: flex;
        }

        /* ===== Methodology Section (Apple Style) ===== */
        .methodology-section {
            display: none;
            flex-direction: column;
            min-height: 100vh;
            padding: var(--space-xl) var(--space-lg);
            padding-bottom: calc(var(--tab-bar-height) + var(--space-xl));
            align-items: center;
            justify-content: center;
        }

        .methodology-section.active {
            display: flex;
        }

        .methodology-header {
            text-align: center;
            margin-top: var(--space-xl);
            margin-bottom: var(--space-2xl);
        }

        .methodology-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: var(--space-xs);
            letter-spacing: -0.02em;
        }

        .methodology-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* Pipeline Container */
        .methodology-pipeline {
            display: flex;
            flex-direction: column;
            gap: 0;
            max-width: 600px;
            width: 100%;
        }

        /* Step Item */
        .pipeline-step {
            display: flex;
            align-items: flex-start;
            gap: var(--space-lg);
            position: relative;
        }

        /* Step Number Column */
        .step-number-col {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0;
        }

        .step-number {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--gradient-color-2));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--bg-primary);
            flex-shrink: 0;
        }

        .step-line {
            width: 2px;
            height: 40px;
            background: linear-gradient(to bottom, var(--primary), transparent);
            opacity: 0.3;
        }

        .pipeline-step:last-child .step-line {
            display: none;
        }

        /* Step Content */
        .step-content {
            flex: 1;
            padding-bottom: var(--space-lg);
        }

        .step-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .step-desc {
            font-size: 0.9375rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .step-metric {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: var(--space-sm);
            padding: 6px 12px;
            background: rgba(90, 154, 110, 0.1);
            border-radius: 100px;
            font-size: 0.8125rem;
            color: var(--primary);
            font-weight: 500;
        }

        .step-metric-value {
            font-weight: 700;
            color: var(--gold);
        }

        /* AI Disclaimer */
        .methodology-disclaimer {
            margin-top: var(--space-2xl);
            text-align: center;
            color: var(--text-muted);
            font-size: 0.8125rem;
            max-width: 500px;
            line-height: 1.5;
        }

        /* Footer Note */
        .methodology-footer {
            margin-top: var(--space-md);
            text-align: center;
            color: var(--text-tertiary);
            font-size: 0.875rem;
            max-width: 500px;
        }

        .methodology-footer a {
            color: var(--primary);
            text-decoration: none;
        }

        .methodology-footer a:hover {
            text-decoration: underline;
        }

        /* License Notice */
        .license-notice {
            margin-top: var(--space-2xl);
            padding: var(--space-lg);
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(90, 154, 110, 0.1);
            border-radius: 12px;
            max-width: 700px;
        }

        .license-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: var(--space-md);
            text-align: center;
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid rgba(90, 154, 110, 0.1);
        }

        .license-content {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .license-section {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .license-text {
            font-size: 0.75rem;
            line-height: 1.6;
            color: var(--text-muted);
            text-align: justify;
        }

        .license-text a {
            color: var(--primary);
            text-decoration: none;
        }

        .license-text a:hover {
            text-decoration: underline;
        }

        .contact-notice {
            color: var(--text-tertiary);
        }

        .license-contact {
            text-align: center;
            margin-top: var(--space-sm);
        }

        .license-contact a {
            color: var(--gold);
            font-size: 0.85rem;
            font-weight: 500;
            text-decoration: none;
        }

        .license-contact a:hover {
            text-decoration: underline;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .methodology-title {
                font-size: 1.5rem;
            }
            .step-number {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            .step-line {
                height: 32px;
            }
        }

        /* ===== Desktop Navigation ===== */
        .desktop-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: var(--glass-blur);
            border-bottom: 1px solid var(--glass-border);
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-xl);
            z-index: 1000;
            transform: translateY(-100%);
            transition: transform var(--transition-normal);
        }

        .desktop-nav.visible {
            transform: translateY(0);
        }

        .desktop-nav-brand {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .desktop-nav-brand:hover {
            color: var(--primary);
        }

        .desktop-nav-links {
            display: flex;
            gap: var(--space-xs);
        }

        .desktop-nav-link {
            padding: var(--space-sm) var(--space-md);
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition-fast);
            border: none;
            background: transparent;
        }

        .desktop-nav-link:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .desktop-nav-link.active {
            background: rgba(90, 154, 110, 0.15);
            color: var(--primary);
        }

        /* ===== Responsive ===== */
        @media (min-width: 768px) {
            .tab-bar {
                display: none;
            }

            .desktop-nav {
                display: flex;
            }

            .chat-section, .library-section, .methodology-section {
                padding-bottom: 0;
                padding-top: var(--header-height);
            }

            /* Hide chat header on desktop - use desktop nav instead */
            .chat-header {
                display: none;
            }

            .chat-input-container {
                bottom: 0;
            }
        }

        @media (max-width: 767px) {
            .hero {
                padding: var(--space-lg);
            }

            .hero-stats {
                gap: var(--space-lg);
            }

            .btn {
                padding: var(--space-sm) var(--space-lg);
                font-size: 0.9375rem;
            }

            .sample-questions {
                max-width: 100%;
            }

            /* More padding on mobile for input + chips + tab bar */
            .chat-container {
                padding-bottom: 220px;
            }

            /* Stack chips vertically on small screens */
            .chat-options {
                flex-direction: column;
                gap: var(--space-xs);
            }

            .chat-option-divider {
                display: none;
            }

            .chat-option-group {
                width: 100%;
                justify-content: flex-start;
            }
        }

        /* ===== Chat History Sidebar ===== */
        .chat-history-sidebar {
            position: fixed;
            left: 0;
            top: var(--header-height);
            bottom: 0;
            width: 280px;
            background: var(--bg-medium);
            border-right: 1px solid var(--glass-border);
            display: none;
            flex-direction: column;
            z-index: 99;
        }

        .chat-history-sidebar.visible {
            display: flex;
        }

        .chat-history-header {
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-history-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .new-chat-btn {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-sm) var(--space-md);
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 0.8125rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .new-chat-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(90, 154, 110, 0.3);
        }

        .chat-history-list {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-sm);
        }

        .chat-history-empty {
            padding: var(--space-xl);
            text-align: center;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .chat-history-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-md);
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition-fast);
            margin-bottom: var(--space-xs);
        }

        .chat-history-item:hover {
            background: rgba(90, 154, 110, 0.1);
        }

        .chat-history-item.active {
            background: rgba(90, 154, 110, 0.15);
            border: 1px solid rgba(90, 154, 110, 0.3);
        }

        .chat-history-item-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            flex-shrink: 0;
        }

        .chat-history-item-content {
            flex: 1;
            min-width: 0;
        }

        .chat-history-item-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-history-item-date {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .chat-history-item-delete {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: var(--transition-fast);
        }

        .chat-history-item:hover .chat-history-item-delete {
            opacity: 1;
        }

        .chat-history-item-delete:hover {
            background: rgba(255, 59, 48, 0.1);
            color: #ff3b30;
        }

        /* Login prompt in sidebar */
        .chat-history-login-prompt {
            padding: var(--space-lg);
            text-align: center;
        }

        .chat-history-login-prompt p {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: var(--space-md);
            line-height: 1.5;
        }

        .login-prompt-btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-lg);
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 100px;
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .login-prompt-btn:hover {
            background: rgba(90, 154, 110, 0.1);
            border-color: var(--primary);
        }

        /* Sidebar toggle button */
        .sidebar-toggle-btn {
            display: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            cursor: pointer;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
        }

        .sidebar-toggle-btn:hover {
            background: rgba(90, 154, 110, 0.1);
            color: var(--text-primary);
        }

        /* Mobile History Drawer */
        .chat-history-drawer {
            position: fixed;
            inset: 0;
            z-index: 2000;
            display: none;
        }

        .chat-history-drawer.active {
            display: block;
        }

        .history-drawer-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .history-drawer-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            max-height: 70vh;
            background: var(--bg-dark);
            border-radius: 20px 20px 0 0;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s var(--ease-out);
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .history-drawer-handle {
            width: 36px;
            height: 4px;
            background: var(--glass-border);
            border-radius: 2px;
            margin: var(--space-sm) auto var(--space-md);
        }

        .history-drawer-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-lg) var(--space-md);
            border-bottom: 1px solid var(--glass-border);
        }

        .history-drawer-header h3 {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .history-drawer-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .history-drawer-body {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-md);
        }

        .history-drawer-new-chat {
            margin: var(--space-md);
            padding: var(--space-md);
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
        }

        /* Desktop: Show toggle button and adjust layout when sidebar open */
        @media (min-width: 768px) {
            .sidebar-toggle-btn {
                display: flex;
            }

            /* When sidebar is visible, adjust chat section */
            body.sidebar-open .chat-section {
                margin-left: 280px;
            }

            body.sidebar-open .chat-input-container {
                left: 280px;
            }
        }

        /* ===== Utilities ===== */
        .hidden {
            display: none !important;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }
    </style>
</head>
<body>
    <!-- Ambient Background -->
    <div class="ambient-bg">
        <div class="ambient-orb ambient-orb-1"></div>
        <div class="ambient-orb ambient-orb-2"></div>
        <div class="ambient-orb ambient-orb-3"></div>
    </div>

    <!-- Desktop Navigation -->
    <nav class="desktop-nav" id="desktopNav">
        <div class="desktop-nav-brand" onclick="goHome()">
            <button class="sidebar-toggle-btn" onclick="event.stopPropagation(); toggleSidebar();" title="채팅 기록">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    <path d="M8 9h8M8 13h6"/>
                </svg>
            </button>
            <span>&#x2638;</span>
            <span>불교 AI</span>
        </div>
        <div class="desktop-nav-links">
            <button class="desktop-nav-link active" data-tab="chat" onclick="switchTab('chat')">채팅</button>
            <button class="desktop-nav-link" data-tab="library" onclick="switchTab('library')">라이브러리</button>
            <button class="desktop-nav-link" data-tab="methodology" onclick="switchTab('methodology')">방법론</button>
        </div>
    </nav>

    <!-- Chat History Sidebar (Desktop) -->
    <aside class="chat-history-sidebar" id="chatHistorySidebar">
        <div class="chat-history-header">
            <span class="chat-history-title">채팅 기록</span>
            <button class="new-chat-btn" onclick="startNewChat()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"/>
                </svg>
                새 채팅
            </button>
        </div>
        <div class="chat-history-list" id="chatHistoryList">
            <!-- Login prompt or history items will be rendered here -->
        </div>
    </aside>

    <!-- App -->
    <div class="app">
        <!-- Hero Section -->
        <section class="hero" id="hero">
            <div class="hero-content">
                <div class="hero-icon">&#x2638;</div>
                <h1 class="hero-title">불교 AI 대장경 탐색기</h1>
                <p class="hero-subtitle">
                    2,459개 CBETA 대장경을<br>
                    AI와 함께 탐험하세요
                </p>

                <div class="hero-stats">
                    <div class="hero-stat">
                        <div class="hero-stat-value">99,723</div>
                        <div class="hero-stat-label">문헌 청크</div>
                    </div>
                    <div class="hero-stat">
                        <div class="hero-stat-value">2,459</div>
                        <div class="hero-stat-label">문헌 수</div>
                    </div>
                    <div class="hero-stat">
                        <div class="hero-stat-value">Gemini</div>
                        <div class="hero-stat-label">2.5 Pro</div>
                    </div>
                </div>

                <div class="hero-cta">
                    <button class="btn btn-primary" onclick="startChat()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        </svg>
                        질문하기
                    </button>
                    <button class="btn btn-secondary" onclick="switchTab('library')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                        </svg>
                        문헌 둘러보기
                    </button>
                </div>

                <div class="sample-questions">
                    <button class="sample-question" onclick="askQuestion('사성제란 무엇인가요?')">사성제란?</button>
                    <button class="sample-question" onclick="askQuestion('팔정도의 각 요소를 설명해주세요')">팔정도란?</button>
                    <button class="sample-question" onclick="askQuestion('무아의 개념을 설명해주세요')">무아란?</button>
                    <button class="sample-question" onclick="askQuestion('연기법이란 무엇인가요?')">연기법이란?</button>
                </div>
            </div>

            <div class="scroll-indicator" title="클릭하여 시작">
                <span>클릭하여 시작하기</span>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M19 12l-7 7-7-7"/>
                </svg>
            </div>
        </section>

        <!-- Chat Section -->
        <section class="chat-section" id="chatSection">
            <header class="chat-header">
                <div class="chat-header-title">
                    <span>&#x2638;</span>
                    <span>불교 AI</span>
                </div>
                <div class="chat-header-actions">
                    <button class="icon-btn" onclick="clearChat()" title="새 대화">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                    </button>
                </div>
            </header>

            <div class="chat-container" id="chatContainer">
                <div class="chat-messages" id="chatMessages">
                    <!-- Welcome Message -->
                    <div class="chat-welcome" id="chatWelcome">
                        <div class="chat-welcome-icon">&#x2638;</div>
                        <h2 class="chat-welcome-title">불교 AI에 오신 것을 환영합니다</h2>
                        <p class="chat-welcome-desc">
                            2,459개 CBETA 대장경을 기반으로<br>
                            불교에 대한 질문에 답변해 드립니다.
                        </p>
                        <div class="chat-welcome-suggestions">
                            <button class="welcome-suggestion" onclick="askQuestion('사성제란 무엇인가요?')">사성제란?</button>
                            <button class="welcome-suggestion" onclick="askQuestion('팔정도를 설명해주세요')">팔정도란?</button>
                            <button class="welcome-suggestion" onclick="askQuestion('무아의 개념이란?')">무아란?</button>
                            <button class="welcome-suggestion" onclick="askQuestion('연기법이란 무엇인가요?')">연기법이란?</button>
                        </div>
                    </div>
                </div>

                <!-- Progress Indicator (Apple Watch Style) -->
                <div class="progress-indicator" id="progressIndicator">
                    <div class="progress-ring-container">
                        <div class="progress-ring" id="progressRing">
                            <div class="progress-ring-inner">
                                <span class="progress-dharma">☸</span>
                            </div>
                        </div>
                    </div>
                    <div class="progress-text" id="progressText">문헌 검색 중...</div>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <!-- Chat Options (Chips) -->
                    <div class="chat-options">
                        <div class="chat-option-group">
                            <span class="chat-option-label">응답</span>
                            <button class="chat-chip active" data-mode="normal" onclick="setResponseMode('normal')">일반</button>
                            <button class="chat-chip" data-mode="detailed" onclick="setResponseMode('detailed')">상세</button>
                            <button class="chat-chip" data-mode="academic" onclick="setResponseMode('academic')">학술적</button>
                        </div>
                        <div class="chat-option-divider"></div>
                        <div class="chat-option-group">
                            <span class="chat-option-label">전통</span>
                            <button class="chat-chip active" data-tradition="all" onclick="setTraditionFilter('all')">전체</button>
                            <button class="chat-chip" data-tradition="초기불교" onclick="setTraditionFilter('초기불교')">초기불교</button>
                            <button class="chat-chip" data-tradition="대승불교" onclick="setTraditionFilter('대승불교')">대승불교</button>
                            <button class="chat-chip" data-tradition="선불교" onclick="setTraditionFilter('선불교')">선불교</button>
                        </div>
                        <div class="chat-option-divider"></div>
                        <div class="chat-option-group">
                            <span class="chat-option-label">문헌</span>
                            <div class="sutra-select-chip" id="sutraSelectChip" onclick="openSutraSelector()">
                                <span class="sutra-select-name" id="sutraSelectName">전체 문헌</span>
                            </div>
                        </div>
                    </div>
                    <div class="chat-input-row">
                        <input
                            type="text"
                            class="chat-input"
                            id="chatInput"
                            placeholder="불교에 대해 무엇이든 물어보세요..."
                            autocomplete="off"
                        >
                        <button class="chat-send-btn" id="sendBtn" onclick="sendMessage()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Library Section -->
        <section class="library-section" id="librarySection">
            <div id="libraryOverlay" class="library-overlay active" style="position: relative; display: flex; opacity: 1;">
                <div class="library-container" id="libraryContainer" style="pointer-events: auto;">
                    <div class="library-header">
                        <div class="library-header-top">
                            <h2 id="libraryTitle">문헌 라이브러리</h2>
                        </div>
                        <div class="library-search-bar">
                            <input type="text" id="librarySearch" placeholder="문헌 제목, 내용 검색..." oninput="handleSearchInput()">
                        </div>
                        <div class="library-filters library-filters-desktop">
                            <select id="libraryThemeFilter" onchange="filterLibraryCards()">
                                <option value="">모든 주제</option>
                            </select>
                            <select id="libraryTraditionFilter" onchange="filterLibraryCards()">
                                <option value="">모든 전통</option>
                            </select>
                            <button class="filter-reset-btn" onclick="resetAllFilters()">초기화</button>
                        </div>
                        <button class="mobile-filter-btn" onclick="openMobileFilters()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 21v-7M4 10V3M12 21v-9M12 8V3M20 21v-5M20 12V3M1 14h6M9 8h6M17 16h6"/>
                            </svg>
                            필터
                            <span class="filter-count" id="mobileFilterCount" style="display:none;">0</span>
                        </button>
                        <div id="libraryFilterBadges" class="library-filter-badges"></div>
                        <div class="library-results-count" id="libraryResultsCount">
                            전체 <span>0</span>개 문헌
                        </div>
                    </div>
                    <div id="libraryLoading" class="library-loading" style="display: none;">
                        <div class="loading-spinner"></div>
                        <p>문헌을 불러오는 중...</p>
                    </div>
                    <div id="libraryEmpty" class="library-empty" style="display: none;">
                        <div class="empty-icon">&#128218;</div>
                        <h3>검색 결과가 없습니다</h3>
                        <p>다른 검색어나 필터를 시도해보세요</p>
                    </div>
                    <div class="library-grid" id="libraryGrid"></div>
                </div>
            </div>
        </section>

        <!-- Methodology Section -->
        <section class="methodology-section" id="methodologySection">
            <div class="methodology-header">
                <h2 class="methodology-title">작동 방식</h2>
                <p class="methodology-subtitle">질문에서 답변까지</p>
            </div>

            <div class="methodology-pipeline">
                <div class="pipeline-step">
                    <div class="step-number-col">
                        <div class="step-number">1</div>
                        <div class="step-line"></div>
                    </div>
                    <div class="step-content">
                        <h3 class="step-title">CBETA 대장경</h3>
                        <p class="step-desc">대정신수대장경(T) 2,459개 문헌을 1024 토큰 단위로 분할</p>
                        <div class="step-metric"><span class="step-metric-value">99,723</span>개 청크</div>
                    </div>
                </div>

                <div class="pipeline-step">
                    <div class="step-number-col">
                        <div class="step-number">2</div>
                        <div class="step-line"></div>
                    </div>
                    <div class="step-content">
                        <h3 class="step-title">벡터 임베딩</h3>
                        <p class="step-desc">Gemini embedding-001로 의미 벡터 변환</p>
                        <div class="step-metric"><span class="step-metric-value">3,072</span>차원</div>
                    </div>
                </div>

                <div class="pipeline-step">
                    <div class="step-number-col">
                        <div class="step-number">3</div>
                        <div class="step-line"></div>
                    </div>
                    <div class="step-content">
                        <h3 class="step-title">의미 검색</h3>
                        <p class="step-desc">질문과 가장 유사한 문헌 구절을 코사인 유사도로 검색</p>
                        <div class="step-metric">Top <span class="step-metric-value">10~20</span> 검색</div>
                    </div>
                </div>

                <div class="pipeline-step">
                    <div class="step-number-col">
                        <div class="step-number">4</div>
                        <div class="step-line"></div>
                    </div>
                    <div class="step-content">
                        <h3 class="step-title">AI 답변 생성</h3>
                        <p class="step-desc">Gemini 2.5 Pro가 검색된 문헌을 기반으로 답변 작성</p>
                        <div class="step-metric"><span class="step-metric-value">2M</span> 토큰 컨텍스트</div>
                    </div>
                </div>
            </div>

            <p class="methodology-disclaimer">
                본 서비스는 인공지능 기반으로 생성된 답변을 제공하며, 부정확하거나 오류가 포함될 수 있습니다.
            </p>

            <p class="methodology-footer">
                데이터 출처: <a href="https://cbeta.org" target="_blank" rel="noopener">CBETA 전자불전협회</a>
            </p>

            <!-- License & Legal Notice -->
            <div class="license-notice">
                <h4 class="license-title">라이선스 및 법적 고지 / License & Legal Notice</h4>

                <div class="license-content">
                    <div class="license-section">
                        <p class="license-text">
                            본 서비스에서 사용된 모든 문헌 데이터는 <a href="https://cbeta.org" target="_blank" rel="noopener">CBETA(中華電子佛典協會)</a>의
                            <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 라이선스에 따라
                            비영리 교육 및 연구 목적으로만 제공됩니다. 본 프로젝트는 CBETA의 라이선스 조건을 엄격히 준수하고 있습니다.
                        </p>
                        <p class="license-text">
                            All sutra data used in this service is provided under the
                            <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> license from
                            <a href="https://cbeta.org" target="_blank" rel="noopener">CBETA (Chinese Buddhist Electronic Text Association)</a>,
                            strictly for non-commercial educational and research purposes. This project fully complies with CBETA's licensing terms.
                        </p>
                    </div>

                    <div class="license-section">
                        <p class="license-text contact-notice">
                            저작권 또는 라이선스 관련 문의사항이 있으시면 아래 이메일로 연락해 주시기 바랍니다.
                            문제가 확인될 경우 즉시 해당 콘텐츠를 수정하거나 삭제하겠습니다.
                        </p>
                        <p class="license-text contact-notice">
                            For any copyright or licensing concerns, please contact us at the email below.
                            We will promptly modify or remove any content upon verification of any issues.
                        </p>
                        <p class="license-contact">
                            <a href="mailto:ltk118698@gmail.com">ltk118698@gmail.com</a>
                        </p>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Mobile Tab Bar -->
    <nav class="tab-bar" id="tabBar">
        <div class="tab-item active" onclick="switchTab('chat')" data-tab="chat">
            <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
            <span class="tab-label">채팅</span>
        </div>
        <div class="tab-item" onclick="openHistoryDrawer()" data-tab="history">
            <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
            </svg>
            <span class="tab-label">기록</span>
        </div>
        <div class="tab-item" onclick="switchTab('library')" data-tab="library">
            <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
            </svg>
            <span class="tab-label">라이브러리</span>
        </div>
        <div class="tab-item" onclick="switchTab('methodology')" data-tab="methodology">
            <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 16v-4M12 8h.01"/>
            </svg>
            <span class="tab-label">방법론</span>
        </div>
    </nav>

    <!-- Mobile Chat History Drawer -->
    <div class="chat-history-drawer" id="chatHistoryDrawer">
        <div class="history-drawer-backdrop" onclick="closeHistoryDrawer()"></div>
        <div class="history-drawer-content">
            <div class="history-drawer-handle"></div>
            <div class="history-drawer-header">
                <h3>채팅 기록</h3>
                <button class="history-drawer-close" onclick="closeHistoryDrawer()">&times;</button>
            </div>
            <div class="history-drawer-body" id="historyDrawerBody">
                <!-- History items will be rendered here -->
            </div>
            <button class="history-drawer-new-chat" onclick="startNewChat(); closeHistoryDrawer();">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"/>
                </svg>
                새 채팅 시작
            </button>
        </div>
    </div>

    <!-- Mobile Filter Drawer -->
    <div class="mobile-filter-drawer" id="mobileFilterDrawer">
        <div class="drawer-backdrop" onclick="closeMobileFilters()"></div>
        <div class="drawer-content">
            <div class="drawer-handle"></div>
            <div class="drawer-header">
                <h3>필터</h3>
                <button class="drawer-close" onclick="closeMobileFilters()">&times;</button>
            </div>
            <div class="drawer-body">
                <div class="drawer-filter-group">
                    <label>주제</label>
                    <select id="mobileThemeFilter" onchange="syncMobileFilter('theme')">
                        <option value="">모든 주제</option>
                    </select>
                </div>
                <div class="drawer-filter-group">
                    <label>전통</label>
                    <select id="mobileTraditionFilter" onchange="syncMobileFilter('tradition')">
                        <option value="">모든 전통</option>
                    </select>
                </div>
            </div>
            <div class="drawer-footer">
                <button class="drawer-reset-btn" onclick="resetAllFilters(); closeMobileFilters();">초기화</button>
                <button class="drawer-apply-btn" onclick="closeMobileFilters()">적용</button>
            </div>
        </div>
    </div>

    <!-- Library JavaScript -->
    <script src="js/library.js"></script>

    <!-- Main JavaScript -->
    <script>
        // ===== State =====
        let currentTab = 'hero';
        let isHeroVisible = true;
        let allSources = [];
        let currentSessionUuid = null;  // Current chat session UUID
        let chatSessions = [];          // List of user's chat sessions
        let isLoggedIn = false;         // User login status
        let currentUser = null;         // Current user info

        // Chat options state
        let chatOptions = {
            responseMode: 'normal',  // normal, detailed, academic
            traditionFilter: 'all',  // all, 초기불교, 대승불교, 선불교
            selectedSutra: null      // { text_id, title } or null
        };

        // ===== Chat History Functions =====

        // Check if user is logged in
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/users/me', { credentials: 'include' });
                if (response.ok) {
                    currentUser = await response.json();
                    isLoggedIn = true;
                    return true;
                }
            } catch (e) {
                console.log('Not logged in');
            }
            isLoggedIn = false;
            currentUser = null;
            return false;
        }

        // Load chat sessions from API
        async function loadChatSessions() {
            if (!isLoggedIn) {
                renderLoginPrompt();
                return;
            }

            try {
                const response = await fetch('/api/chat/sessions', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    chatSessions = data.sessions || [];
                    renderChatHistory();
                } else if (response.status === 401) {
                    isLoggedIn = false;
                    renderLoginPrompt();
                }
            } catch (e) {
                console.error('Failed to load chat sessions:', e);
                renderChatHistory();
            }
        }

        // Render login prompt for non-logged-in users
        function renderLoginPrompt() {
            const listEl = document.getElementById('chatHistoryList');
            const drawerBody = document.getElementById('historyDrawerBody');

            const promptHtml = `
                <div class="chat-history-login-prompt">
                    <p>로그인하면 채팅 기록을<br>저장하고 관리할 수 있습니다</p>
                    <button class="login-prompt-btn" onclick="window.location.href='/auth/login/google'">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Google로 로그인
                    </button>
                </div>
            `;

            if (listEl) listEl.innerHTML = promptHtml;
            if (drawerBody) drawerBody.innerHTML = promptHtml;
        }

        // Render chat history list
        function renderChatHistory() {
            const listEl = document.getElementById('chatHistoryList');
            const drawerBody = document.getElementById('historyDrawerBody');

            if (chatSessions.length === 0) {
                const emptyHtml = `
                    <div class="chat-history-empty">
                        <p>아직 저장된 채팅이 없습니다</p>
                        <p style="margin-top: 8px; font-size: 0.75rem;">새로운 질문을 시작해보세요!</p>
                    </div>
                `;
                if (listEl) listEl.innerHTML = emptyHtml;
                if (drawerBody) drawerBody.innerHTML = emptyHtml;
                return;
            }

            const itemsHtml = chatSessions.map(session => `
                <div class="chat-history-item ${session.session_uuid === currentSessionUuid ? 'active' : ''}"
                     onclick="loadChatSession('${session.session_uuid}')"
                     data-session-uuid="${session.session_uuid}">
                    <div class="chat-history-item-icon">&#x2638;</div>
                    <div class="chat-history-item-content">
                        <div class="chat-history-item-title">${escapeHtml(session.title || '새 대화')}</div>
                        <div class="chat-history-item-date">${formatRelativeTime(session.last_message_at)}</div>
                    </div>
                    <button class="chat-history-item-delete" onclick="event.stopPropagation(); deleteChatSession('${session.session_uuid}')" title="삭제">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                        </svg>
                    </button>
                </div>
            `).join('');

            if (listEl) listEl.innerHTML = itemsHtml;
            if (drawerBody) drawerBody.innerHTML = itemsHtml;
        }

        // Load a specific chat session
        async function loadChatSession(sessionUuid) {
            try {
                const response = await fetch(`/api/chat/sessions/${sessionUuid}/messages`, { credentials: 'include' });
                if (!response.ok) throw new Error('Failed to load messages');

                const data = await response.json();
                currentSessionUuid = sessionUuid;

                // Clear current messages and render loaded messages
                const messagesEl = document.getElementById('chatMessages');
                const welcome = document.getElementById('chatWelcome');
                if (welcome) welcome.style.display = 'none';

                // Clear existing messages (except welcome)
                messagesEl.innerHTML = '';

                // Render each message
                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(msg => {
                        addMessageToUI(msg.role, msg.content, msg.created_at);
                    });
                } else {
                    // Show welcome if no messages
                    messagesEl.innerHTML = getWelcomeHtml();
                }

                // Update active state in sidebar
                updateActiveSession(sessionUuid);

                // Close drawer if on mobile
                closeHistoryDrawer();

                // Switch to chat tab
                switchTab('chat');

            } catch (e) {
                console.error('Failed to load chat session:', e);
            }
        }

        // Add message to UI (for loaded messages)
        function addMessageToUI(role, content, timestamp) {
            const messages = document.getElementById('chatMessages');
            const time = timestamp ? new Date(timestamp).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }) : '';

            const html = `
                <div class="message ${role}">
                    <div class="message-avatar">${role === 'user' ? '&#128100;' : '&#x2638;'}</div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-sender">${role === 'user' ? '나' : '불교 AI'}</span>
                            <span class="message-time">${time}</span>
                        </div>
                        <div class="message-text">${formatMessage(content)}</div>
                    </div>
                </div>
            `;

            messages.insertAdjacentHTML('beforeend', html);
        }

        // Delete a chat session
        async function deleteChatSession(sessionUuid) {
            if (!confirm('이 대화를 삭제하시겠습니까?')) return;

            try {
                const response = await fetch(`/api/chat/sessions/${sessionUuid}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    // Remove from local list
                    chatSessions = chatSessions.filter(s => s.session_uuid !== sessionUuid);
                    renderChatHistory();

                    // If deleted current session, start new chat
                    if (currentSessionUuid === sessionUuid) {
                        startNewChat();
                    }
                }
            } catch (e) {
                console.error('Failed to delete session:', e);
            }
        }

        // Start a new chat
        function startNewChat() {
            currentSessionUuid = null;
            clearChat();
            updateActiveSession(null);
            document.getElementById('chatInput').focus();
        }

        // Update active state in history list
        function updateActiveSession(sessionUuid) {
            document.querySelectorAll('.chat-history-item').forEach(item => {
                item.classList.toggle('active', item.dataset.sessionUuid === sessionUuid);
            });
        }

        // Toggle sidebar visibility
        function toggleSidebar() {
            const sidebar = document.getElementById('chatHistorySidebar');
            const isVisible = sidebar.classList.contains('visible');

            if (isVisible) {
                sidebar.classList.remove('visible');
                document.body.classList.remove('sidebar-open');
            } else {
                sidebar.classList.add('visible');
                document.body.classList.add('sidebar-open');
                // Load sessions when opening
                if (isLoggedIn) {
                    loadChatSessions();
                }
            }
        }

        // Open mobile history drawer
        function openHistoryDrawer() {
            const drawer = document.getElementById('chatHistoryDrawer');
            drawer.classList.add('active');
            // Load sessions
            loadChatSessions();
        }

        // Close mobile history drawer
        function closeHistoryDrawer() {
            const drawer = document.getElementById('chatHistoryDrawer');
            drawer.classList.remove('active');
        }

        // Helper: Format relative time
        function formatRelativeTime(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return '방금 전';
            if (diffMins < 60) return `${diffMins}분 전`;
            if (diffHours < 24) return `${diffHours}시간 전`;
            if (diffDays < 7) return `${diffDays}일 전`;
            return date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
        }

        // Helper: Escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Helper: Get welcome HTML
        function getWelcomeHtml() {
            return `
                <div class="chat-welcome" id="chatWelcome">
                    <div class="chat-welcome-icon">&#x2638;</div>
                    <h2 class="chat-welcome-title">불교 AI에 오신 것을 환영합니다</h2>
                    <p class="chat-welcome-desc">
                        2,459개 CBETA 대장경을 기반으로<br>
                        불교에 대한 질문에 답변해 드립니다.
                    </p>
                    <div class="chat-welcome-suggestions">
                        <button class="welcome-suggestion" onclick="askQuestion('사성제란 무엇인가요?')">사성제란?</button>
                        <button class="welcome-suggestion" onclick="askQuestion('팔정도를 설명해주세요')">팔정도란?</button>
                        <button class="welcome-suggestion" onclick="askQuestion('무아의 개념이란?')">무아란?</button>
                        <button class="welcome-suggestion" onclick="askQuestion('연기법이란 무엇인가요?')">연기법이란?</button>
                    </div>
                </div>
            `;
        }

        // ===== Chat Options Functions =====
        function setResponseMode(mode) {
            chatOptions.responseMode = mode;
            // Update chip UI
            document.querySelectorAll('.chat-chip[data-mode]').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.mode === mode);
            });
        }

        function setTraditionFilter(tradition) {
            chatOptions.traditionFilter = tradition;
            // Update chip UI
            document.querySelectorAll('.chat-chip[data-tradition]').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.tradition === tradition);
            });
            // Clear specific sutra if tradition filter changes
            if (tradition !== 'all' && chatOptions.selectedSutra) {
                clearSelectedSutra();
            }
        }

        function selectSutraForChat(textId, title) {
            chatOptions.selectedSutra = { text_id: textId, title: title };
            updateSutraSelectUI();
            // Clear tradition filter when specific sutra selected
            setTraditionFilter('all');
        }

        function clearSelectedSutra() {
            chatOptions.selectedSutra = null;
            updateSutraSelectUI();
        }

        function updateSutraSelectUI() {
            const chip = document.getElementById('sutraSelectChip');
            const nameEl = document.getElementById('sutraSelectName');

            if (chatOptions.selectedSutra) {
                chip.classList.add('has-selection');
                nameEl.innerHTML = `${chatOptions.selectedSutra.title} <button class="sutra-select-clear" onclick="event.stopPropagation(); clearSelectedSutra();">×</button>`;
            } else {
                chip.classList.remove('has-selection');
                nameEl.textContent = '전체 문헌';
            }
        }

        function openSutraSelector() {
            // Navigate to library tab to select a sutra
            switchTab('library');
        }

        // Function to be called from library detail page
        function askAboutSutra(textId, title) {
            selectSutraForChat(textId, title);
            switchTab('chat');
            document.getElementById('chatInput').focus();
        }

        // ===== Tab Navigation =====
        function switchTab(tab) {
            // Hide hero
            document.getElementById('hero').classList.add('hidden');
            isHeroVisible = false;

            // Show desktop navigation
            document.getElementById('desktopNav').classList.add('visible');

            // Update sections
            document.querySelectorAll('.chat-section, .library-section, .methodology-section').forEach(s => {
                s.classList.remove('active');
            });

            // Activate selected section
            if (tab === 'chat') {
                document.getElementById('chatSection').classList.add('active');
            } else if (tab === 'library') {
                document.getElementById('librarySection').classList.add('active');
                // Trigger library load if needed
                if (typeof loadInitialCards === 'function' && typeof libraryState !== 'undefined' && libraryState.cards.length === 0) {
                    loadInitialCards();
                }
            } else if (tab === 'methodology') {
                document.getElementById('methodologySection').classList.add('active');
            }

            // Update mobile tab bar
            document.querySelectorAll('.tab-item').forEach(item => {
                item.classList.toggle('active', item.dataset.tab === tab);
            });

            // Update desktop nav links
            document.querySelectorAll('.desktop-nav-link').forEach(link => {
                link.classList.toggle('active', link.dataset.tab === tab);
            });

            currentTab = tab;
        }

        // ===== Go Home =====
        function goHome() {
            // Hide all sections
            document.querySelectorAll('.chat-section, .library-section, .methodology-section').forEach(s => {
                s.classList.remove('active');
            });

            // Show hero
            document.getElementById('hero').classList.remove('hidden');
            isHeroVisible = true;

            // Hide desktop nav
            document.getElementById('desktopNav').classList.remove('visible');

            // Reset tab states
            document.querySelectorAll('.tab-item, .desktop-nav-link').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector('.tab-item[data-tab="chat"]')?.classList.add('active');
            document.querySelector('.desktop-nav-link[data-tab="chat"]')?.classList.add('active');

            currentTab = 'hero';

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ===== Start Chat =====
        function startChat() {
            switchTab('chat');
            document.getElementById('chatInput').focus();
        }

        // ===== Ask Sample Question =====
        function askQuestion(question) {
            switchTab('chat');
            document.getElementById('chatInput').value = question;
            sendMessage();
        }

        // ===== Chat Functions =====
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            // Add user message
            addMessage('user', message);
            input.value = '';

            // Show progress indicator
            const progressIndicator = document.getElementById('progressIndicator');
            progressIndicator.classList.add('active');
            resetProgressStages();
            scrollToBottom();

            try {
                // Build request based on chat options
                const requestBody = {
                    query: message,
                    detailed_mode: chatOptions.responseMode === 'detailed' || chatOptions.responseMode === 'academic'
                };

                // Add session_id if we have a current session
                if (currentSessionUuid) {
                    requestBody.session_id = currentSessionUuid;
                }

                // Add tradition filter if not 'all' and no specific sutra selected
                if (chatOptions.traditionFilter !== 'all' && !chatOptions.selectedSutra) {
                    requestBody.tradition_filter = chatOptions.traditionFilter;
                }

                // Add specific sutra filter if selected
                if (chatOptions.selectedSutra) {
                    requestBody.sutra_filter = chatOptions.selectedSutra.text_id;
                }

                // Add academic mode hint to query if selected
                if (chatOptions.responseMode === 'academic') {
                    requestBody.query = `[학술적 관점에서 상세히 설명해주세요] ${message}`;
                }

                // Use streaming endpoint
                const response = await fetch('/api/chat/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) throw new Error('Chat request failed');

                // Create message container for streaming
                const messageContainer = createStreamingMessage();
                const messageText = messageContainer.querySelector('.message-text');
                messageText.classList.add('streaming');

                // Process SSE stream
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullContent = '';
                let sources = [];

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));

                                switch (data.type) {
                                    case 'stage':
                                        updateProgressStage(data.stage);
                                        break;

                                    case 'content':
                                        // Hide progress indicator when content starts
                                        progressIndicator.classList.remove('active');
                                        // Append content with typing effect
                                        fullContent += data.content;
                                        appendStreamingContent(messageText, data.content);
                                        scrollToBottom();
                                        break;

                                    case 'sources':
                                        sources = data.sources || [];
                                        break;

                                    case 'done':
                                        // Remove streaming cursor
                                        messageText.classList.remove('streaming');
                                        // Add sources
                                        if (sources.length > 0) {
                                            addSourcesToMessage(messageContainer, sources);
                                        }
                                        // Update current session UUID from response
                                        if (data.session_id) {
                                            currentSessionUuid = data.session_id;
                                            // Refresh history list if logged in
                                            if (isLoggedIn) {
                                                setTimeout(() => loadChatSessions(), 500);
                                            }
                                        }
                                        console.log(`Response completed in ${data.latency_ms}ms using ${data.model}`);
                                        break;

                                    case 'error':
                                        progressIndicator.classList.remove('active');
                                        messageText.classList.remove('streaming');
                                        messageText.innerHTML = formatMessage('죄송합니다. 오류가 발생했습니다: ' + data.message);
                                        break;
                                }
                            } catch (e) {
                                console.warn('Failed to parse SSE data:', line);
                            }
                        }
                    }
                }

            } catch (error) {
                console.error('Chat error:', error);
                progressIndicator.classList.remove('active');
                addMessage('assistant', '죄송합니다. 오류가 발생했습니다. 다시 시도해주세요.');
            }
        }

        // Helper functions for streaming (Apple Watch Style)
        const stageMessages = {
            'searching': '문헌 검색 중...',
            'analyzing': '관련 구절 분석 중...',
            'generating': '답변 작성 중...'
        };

        function resetProgressStages() {
            const ring = document.getElementById('progressRing');
            const text = document.getElementById('progressText');
            if (ring) ring.style.setProperty('--progress', '0');
            if (text) text.textContent = stageMessages['searching'];
        }

        function updateProgressStage(stageName) {
            const stages = ['searching', 'analyzing', 'generating'];
            const stageIndex = stages.indexOf(stageName);
            const progress = ((stageIndex + 1) / stages.length) * 100;

            const ring = document.getElementById('progressRing');
            const text = document.getElementById('progressText');

            if (ring) ring.style.setProperty('--progress', progress);
            if (text) text.textContent = stageMessages[stageName] || stageName;

            // Auto scroll to show progress
            scrollToBottom();
        }

        function createStreamingMessage() {
            const messages = document.getElementById('chatMessages');
            const time = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

            // Hide welcome message
            const welcome = document.getElementById('chatWelcome');
            if (welcome) {
                welcome.style.display = 'none';
            }

            const html = `
                <div class="message assistant" id="streamingMessage">
                    <div class="message-avatar">&#x2638;</div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-sender">불교 AI</span>
                            <span class="message-time">${time}</span>
                        </div>
                        <div class="message-text"></div>
                    </div>
                </div>
            `;

            messages.insertAdjacentHTML('beforeend', html);
            scrollToBottom();
            return messages.lastElementChild;
        }

        function appendStreamingContent(messageText, content) {
            // Simply append the text - the CSS cursor handles the typing feel
            const currentHtml = messageText.innerHTML;
            messageText.innerHTML = formatMessage(currentHtml.replace(/▌$/, '') + content);
            // Auto scroll as content streams in
            scrollToBottom();
        }

        function addSourcesToMessage(messageContainer, sources) {
            const messageContent = messageContainer.querySelector('.message-content');
            const sourceHtml = `
                <div class="message-sources">
                    <div class="message-sources-title">참고 문헌</div>
                    <div class="message-source-tags">
                        ${sources.map(s => `<span class="source-tag" onclick="showSourceDetail('${s.text_id}')">${s.title || s.text_id}</span>`).join('')}
                    </div>
                </div>
            `;
            const messageText = messageContainer.querySelector('.message-text');
            messageText.insertAdjacentHTML('afterend', sourceHtml);
            scrollToBottom();
        }

        // Throttled scroll to prevent jitter during streaming
        let scrollTimeout = null;
        function scrollToBottom() {
            if (scrollTimeout) return;
            scrollTimeout = setTimeout(() => {
                scrollTimeout = null;
                const chatMessages = document.getElementById('chatMessages');
                if (chatMessages) {
                    requestAnimationFrame(() => {
                        chatMessages.scrollTo({
                            top: chatMessages.scrollHeight,
                            behavior: 'smooth'
                        });
                    });
                }
            }, 50); // Throttle to max 20 scrolls per second
        }

        function addMessage(role, text, sources = []) {
            const messages = document.getElementById('chatMessages');
            const time = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

            // Hide welcome message on first message
            const welcome = document.getElementById('chatWelcome');
            if (welcome) {
                welcome.style.display = 'none';
            }

            const sourceHtml = sources.length > 0 ? `
                <div class="message-sources">
                    <div class="message-sources-title">참고 문헌</div>
                    <div class="message-source-tags">
                        ${sources.map(s => `<span class="source-tag" onclick="showSourceDetail('${s.text_id}')">${s.title || s.text_id}</span>`).join('')}
                    </div>
                </div>
            ` : '';

            const html = `
                <div class="message ${role}">
                    <div class="message-avatar">${role === 'user' ? '&#128100;' : '&#x2638;'}</div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-sender">${role === 'user' ? '나' : '불교 AI'}</span>
                            <span class="message-time">${time}</span>
                        </div>
                        <div class="message-text">${formatMessage(text)}${sourceHtml}</div>
                    </div>
                </div>
            `;

            messages.insertAdjacentHTML('beforeend', html);
            scrollToBottom();
        }

        function formatMessage(text) {
            // Handle null/undefined
            if (!text) return '';

            // Basic markdown-like formatting
            return String(text)
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
        }

        function clearChat() {
            document.getElementById('chatMessages').innerHTML = `
                <div class="chat-welcome" id="chatWelcome">
                    <div class="chat-welcome-icon">&#x2638;</div>
                    <h2 class="chat-welcome-title">불교 AI에 오신 것을 환영합니다</h2>
                    <p class="chat-welcome-desc">
                        99,723개의 CBETA 대장경을 기반으로<br>
                        불교에 대한 질문에 답변해 드립니다.
                    </p>
                    <div class="chat-welcome-suggestions">
                        <button class="welcome-suggestion" onclick="askQuestion('사성제란 무엇인가요?')">사성제란?</button>
                        <button class="welcome-suggestion" onclick="askQuestion('팔정도를 설명해주세요')">팔정도란?</button>
                        <button class="welcome-suggestion" onclick="askQuestion('무아의 개념이란?')">무아란?</button>
                        <button class="welcome-suggestion" onclick="askQuestion('연기법이란 무엇인가요?')">연기법이란?</button>
                    </div>
                </div>
            `;
        }

        // ===== Keyboard Events =====
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // ===== Load Metadata =====
        async function loadMetadata() {
            try {
                const response = await fetch('/api/sutras/meta');
                if (!response.ok) throw new Error('Failed to load metadata');

                const metadata = await response.json();

                // Populate library filters
                if (typeof window.onLibraryMetadataLoaded === 'function') {
                    window.onLibraryMetadataLoaded(metadata);
                }

                // Store globally
                window.libraryMetadata = metadata;

                console.log('Metadata loaded:', metadata.total, 'sources');
            } catch (error) {
                console.error('Error loading metadata:', error);
            }
        }

        // ===== Expose globals for library.js =====
        window.askAboutSutra = askAboutSutra;
        window.selectSutraForChat = selectSutraForChat;

        // ===== Initialize =====
        document.addEventListener('DOMContentLoaded', async () => {
            // Check auth status first
            await checkAuthStatus();

            // Initialize sidebar content based on auth status
            if (isLoggedIn) {
                loadChatSessions();
            } else {
                renderLoginPrompt();
            }

            loadMetadata();

            // Scroll indicator click handler
            const scrollIndicator = document.querySelector('.scroll-indicator');
            if (scrollIndicator) {
                scrollIndicator.style.cursor = 'pointer';
                scrollIndicator.addEventListener('click', () => {
                    startChat();
                });
            }

            // Intersection observer for hero
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (!entry.isIntersecting && isHeroVisible) {
                        // User scrolled past hero - could auto-switch to chat
                    }
                });
            }, { threshold: 0.1 });

            observer.observe(document.getElementById('hero'));
        });
    </script>
</body>
</html>
