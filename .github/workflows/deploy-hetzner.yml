name: Deploy to Hetzner

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'config/**'
      - 'Dockerfile'
      - '.github/workflows/deploy-hetzner.yml'
  workflow_dispatch:  # ÏàòÎèô Î∞∞Ìè¨ ÌóàÏö©

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USERNAME }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            echo "üéâ Connecting to Hetzner Server..."
            cd /opt/buddha-korea

            echo "üì• Pulling latest code..."
            git config --global --add safe.directory /opt/buddha-korea

            # Î≥ÄÍ≤ΩÎêú ÌååÏùº ÌôïÏù∏
            git fetch origin main
            CHANGED_FILES=$(git diff --name-only HEAD origin/main)
            echo "Changed files: $CHANGED_FILES"

            git pull origin main

            # Dockerfile ÎòêÎäî requirements.txt Î≥ÄÍ≤Ω ÏãúÏóêÎßå ÎπåÎìú
            if echo "$CHANGED_FILES" | grep -qE "(Dockerfile|requirements\.txt)"; then
              echo "üê≥ Dockerfile/requirements changed - Full rebuild..."
              docker compose -f config/docker-compose.yml up -d --build
            else
              echo "üîÑ Code only changed - Quick restart..."
              docker compose -f config/docker-compose.yml up -d --force-recreate
            fi

            echo "üßπ Cleaning up..."
            docker image prune -f

            echo "‚úÖ Deployment Complete!"

      - name: Health Check
        run: |
          echo "Waiting for service to be ready..."
          sleep 30

          for i in {1..5}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 https://buddhakorea.com/api/health 2>/dev/null || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "‚úÖ Health check passed! (attempt $i)"
              exit 0
            fi
            echo "Attempt $i: Status $STATUS, retrying in 10s..."
            sleep 10
          done

          echo "‚ùå Health check failed after 5 attempts"
          exit 1
