name: Deploy to Hetzner

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'config/**'
      - 'Dockerfile'
      - '.github/workflows/deploy-hetzner.yml'
  workflow_dispatch:  # ÏàòÎèô Î∞∞Ìè¨ ÌóàÏö©

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USERNAME }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          port: 22
          command_timeout: 30m
          envs: SECRET_KEY,REDIS_PASSWORD,POSTGRES_PASSWORD,GEMINI_API_KEY,PALI_GEMINI_API_KEY,GCP_PROJECT_ID,GOOGLE_CLIENT_ID,GOOGLE_CLIENT_SECRET,NAVER_CLIENT_ID,NAVER_CLIENT_SECRET,KAKAO_CLIENT_ID,KAKAO_CLIENT_SECRET
          script: |
            echo "üéâ Connecting to Hetzner Server..."
            cd /opt/buddha-korea

            echo "üì• Pulling latest code..."
            git config --global --add safe.directory /opt/buddha-korea

            # Î≥ÄÍ≤ΩÎêú ÌååÏùº ÌôïÏù∏
            git fetch origin main
            CHANGED_FILES=$(git diff --name-only HEAD origin/main)
            echo "Changed files: $CHANGED_FILES"

            git pull origin main

            # Validate required secrets are present
            echo "üîê Validating GitHub Secrets..."
            MISSING_SECRETS=""
            [ -z "$GEMINI_API_KEY" ] && MISSING_SECRETS="$MISSING_SECRETS GEMINI_API_KEY"
            [ -z "$SECRET_KEY" ] && MISSING_SECRETS="$MISSING_SECRETS SECRET_KEY"
            [ -z "$REDIS_PASSWORD" ] && MISSING_SECRETS="$MISSING_SECRETS REDIS_PASSWORD"
            [ -z "$POSTGRES_PASSWORD" ] && MISSING_SECRETS="$MISSING_SECRETS POSTGRES_PASSWORD"
            if [ -n "$MISSING_SECRETS" ]; then
              echo "‚ùå Missing required secrets:$MISSING_SECRETS"
              exit 1
            fi
            echo "‚úÖ All required secrets are present"

            # Generate .env from GitHub Secrets (passed via envs parameter)
            echo "üîê Generating .env from GitHub Secrets..."
            {
              echo "# Auto-generated from GitHub Secrets - DO NOT EDIT MANUALLY"
              echo "GEMINI_API_KEY=${GEMINI_API_KEY}"
              echo "PALI_GEMINI_API_KEY=${PALI_GEMINI_API_KEY}"
              echo "GCP_PROJECT_ID=${GCP_PROJECT_ID}"
              echo "GCP_LOCATION=us-central1"
              echo "USE_GEMINI_FOR_QUERIES=true"
              echo "LLM_MODEL=gemini-2.5-pro"
              echo "LLM_MODEL_FAST=gemini-2.5-flash"
              echo "EMBEDDING_MODEL=BAAI/bge-m3"
              echo "CHROMA_DB_PATH=./chroma_db"
              echo "CHROMA_COLLECTION_NAME=cbeta_sutras_gemini"
              echo "API_HOST=0.0.0.0"
              echo "API_PORT=8000"
              echo "ALLOWED_ORIGINS=https://buddhakorea.com,https://www.buddhakorea.com,https://ai.buddhakorea.com"
              echo "RATE_LIMIT_PER_HOUR=100"
              echo "LOG_LEVEL=info"
              echo "TOP_K_RETRIEVAL=10"
              echo "TOP_K_RETRIEVAL_FAST=5"
              echo "MAX_CONTEXT_TOKENS=8000"
              echo "CHUNK_SIZE=1024"
              echo "CHUNK_OVERLAP=200"
              echo "MAX_WORKERS=4"
              echo "BATCH_SIZE=32"
              echo "SECRET_KEY=${SECRET_KEY}"
              echo "COOKIE_DOMAIN=.buddhakorea.com"
              echo "GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}"
              echo "GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}"
              echo "NAVER_CLIENT_ID=${NAVER_CLIENT_ID}"
              echo "NAVER_CLIENT_SECRET=${NAVER_CLIENT_SECRET}"
              echo "KAKAO_CLIENT_ID=${KAKAO_CLIENT_ID}"
              echo "KAKAO_CLIENT_SECRET=${KAKAO_CLIENT_SECRET}"
              echo "POSTGRES_USER=postgres"
              echo "POSTGRES_PASSWORD=${POSTGRES_PASSWORD}"
              echo "POSTGRES_DB=buddhakorea"
              echo "REDIS_PASSWORD=${REDIS_PASSWORD}"
            } > .env
            chmod 600 .env
            echo "‚úÖ .env generated successfully"

            # Dockerfile ÎòêÎäî requirements.txt Î≥ÄÍ≤Ω ÏãúÏóêÎßå ÎπåÎìú
            if echo "$CHANGED_FILES" | grep -qE "(Dockerfile|requirements\.txt)"; then
              echo "üê≥ Dockerfile/requirements changed - Full rebuild..."
              docker compose -f config/docker-compose.yml up -d --build
            else
              echo "üîÑ Code only changed - Quick restart..."
              docker compose -f config/docker-compose.yml up -d --force-recreate
            fi

            echo "üßπ Cleaning up..."
            docker image prune -f

            # ‚è≥ Wait for all services to be healthy (including nginx)
            echo "‚è≥ Waiting for all services to be healthy..."
            for i in {1..20}; do
              # Check if all containers are running
              RUNNING=$(docker compose -f config/docker-compose.yml ps --format json 2>/dev/null | grep -c '"running"' || echo "0")
              TOTAL=$(docker compose -f config/docker-compose.yml ps --format json 2>/dev/null | wc -l | tr -d ' ')

              if [ "$RUNNING" -ge 4 ]; then
                echo "‚úÖ All $RUNNING containers are running!"
                break
              fi

              echo "  Attempt $i/20: $RUNNING containers running, waiting..."
              sleep 10
            done

            # Show final container status
            echo "üìä Container Status:"
            docker compose -f config/docker-compose.yml ps

            echo "‚úÖ Deployment Complete!"

      - name: Health Check
        run: |
          echo "Waiting for service to be ready..."
          sleep 10

          for i in {1..10}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 https://ai.buddhakorea.com/api/health 2>/dev/null || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "‚úÖ Health check passed! (attempt $i)"
              exit 0
            fi
            echo "Attempt $i: Status $STATUS, retrying in 15s..."
            sleep 15
          done

          echo "‚ùå Health check failed after 10 attempts"
          exit 1
